!function(g,I){"object"==typeof exports&&"undefined"!=typeof module?I(exports):"function"==typeof define&&define.amd?define(["exports"],I):I((g="undefined"!=typeof globalThis?globalThis:g||self).VectorTextProtocol={})}(this,(function(g){"use strict";function I(g){if(g.__esModule)return g;var I=g.default;if("function"==typeof I){var C=function g(){if(this instanceof g){var C=[null];return C.push.apply(C,arguments),new(Function.bind.apply(I,C))}return I.apply(this,arguments)};C.prototype=I.prototype}else C={};return Object.defineProperty(C,"__esModule",{value:!0}),Object.keys(g).forEach((function(I){var A=Object.getOwnPropertyDescriptor(g,I);Object.defineProperty(C,I,A.get?A:{enumerable:!0,get:function(){return g[I]}})})),C}function C(g){return new Function("d","return {"+g.map((function(g,I){return JSON.stringify(g)+": d["+I+"]"})).join(",")+"}")}function A(g){var I=new RegExp('["'+g+"\n]"),A=g.charCodeAt(0);function l(g,I){var C,l,b={},c={},o=[],Z=g.length,d=0,G=0;function n(){if(d>=Z)return c;if(l)return l=!1,b;var I,C=d;if(34===g.charCodeAt(C)){for(var o=C;o++<Z;)if(34===g.charCodeAt(o)){if(34!==g.charCodeAt(o+1))break;++o}return d=o+2,13===(I=g.charCodeAt(o+1))?(l=!0,10===g.charCodeAt(o+2)&&++d):10===I&&(l=!0),g.slice(C+1,o).replace(/""/g,'"')}for(;d<Z;){var G=1;if(10===(I=g.charCodeAt(d++)))l=!0;else if(13===I)l=!0,10===g.charCodeAt(d)&&(++d,++G);else if(I!==A)continue;return g.slice(C,d-G)}return g.slice(C)}for(;(C=n())!==c;){for(var e=[];C!==b&&C!==c;)e.push(C),C=n();I&&null==(e=I(e,G++))||o.push(e)}return o}function b(I){return I.map(c).join(g)}function c(g){return null==g?"":I.test(g+="")?'"'+g.replace(/\"/g,'""')+'"':g}return{parse:function(g,I){var A,b,c=l(g,(function(g,l){if(A)return A(g,l-1);b=g,A=I?function(g,I){var A=C(g);return function(C,l){return I(A(C),l,g)}}(g,I):C(g)}));return c.columns=b,c},parseRows:l,format:function(I,C){return null==C&&(C=function(g){var I=Object.create(null),C=[];return g.forEach((function(g){for(var A in g)A in I||C.push(I[A]=A)})),C}(I)),[C.map(c).join(g)].concat(I.map((function(I){return C.map((function(g){return c(I[g])})).join(g)}))).join("\n")},formatRows:function(g){return g.map(b).join("\n")}}}var l=A(","),b=l.parse,c=l.parseRows,o=l.format,Z=l.formatRows,d=A("\t"),G=d.parse,n=d.parseRows,e=d.format,t=d.formatRows,s=I(Object.freeze({__proto__:null,dsvFormat:A,csvParse:b,csvParseRows:c,csvFormat:o,csvFormatRows:Z,tsvParse:G,tsvParseRows:n,tsvFormat:e,tsvFormatRows:t})),m={};function i(g,I){var C=B(g,I);return C.whole+"° "+(C.minutes?C.minutes+"' ":"")+(C.seconds?C.seconds+'" ':"")+C.dir}function B(g,I){var C=({lat:["N","S"],lon:["E","W"]}[I]||"")[g>=0?0:1],A=Math.abs(g),l=Math.floor(A),b=60*(A-l),c=Math.floor(b);return{whole:l,minutes:c,seconds:Math.floor(60*(b-c)),dir:C}}function W(g,I){if(I||(I="NSEW"),"string"!=typeof g)return null;var C=(g=g.toUpperCase()).match(/^[\s\,]*([NSEW])?\s*([\-|\—|\―]?[0-9.]+)[°º˚]?\s*(?:([0-9.]+)['’′‘]\s*)?(?:([0-9.]+)(?:''|"|”|″)\s*)?([NSEW])?/);if(!C)return null;var A,l=C[0];if(C[1]&&C[5]?(A=C[1],l=l.slice(0,-1)):A=C[1]||C[5],A&&-1===I.indexOf(A))return null;var b=C[2]?parseFloat(C[2]):0,c=C[3]?parseFloat(C[3])/60:0,o=C[4]?parseFloat(C[4])/3600:0,Z=b<0?-1:1;return"S"!==A&&"W"!==A||(Z*=-1),{val:(Math.abs(b)+c+o)*Z,dim:A,matched:l,remain:g.slice(l.length)}}({get exports(){return m},set exports(g){m=g}}).exports=function(g,I){var C=W(g,I);return null===C?null:C.val},m.pair=function(g,I){var C=W(g=g.trim(),I);if(!C)return null;var A=W(g=C.remain.trim(),I);if(!A||A.remain)return null;return C.dim?function(g,I,C){if("N"===C||"S"===C)return[g,I];if("W"===C||"E"===C)return[I,g]}(C.val,A.val,C.dim):[C.val,A.val]},m.format=i,m.formatPair=function(g){return i(g.lat,"lat")+" "+i(g.lon,"lon")},m.coordToDMS=B;var J=s,a=m,u=/(Lat)(itude)?/gi,S=/(L)(on|ng)(gitude)?/i;function V(g,I){var C,A,l;for(var b in g)(A=b.match(I))&&(!C||A[0].length/b.length>l)&&(l=A[0].length/b.length,C=b);return C}function k(g){return V(g,u)}function y(g){return V(g,S)}function h(g){return"object"==typeof g?Object.keys(g).length:0}function X(g){var I=[];return[",",";","\t","|"].forEach((function(C){var A=J.dsvFormat(C).parse(g);if(A.length>=1){for(var l=h(A[0]),b=0;b<A.length;b++)if(h(A[b])!==l)return;I.push({delimiter:C,arity:Object.keys(A[0]).length})}})),I.length?I.sort((function(g,I){return I.arity-g.arity}))[0].delimiter:null}var K={isLon:function(g){return!!g.match(S)},isLat:function(g){return!!g.match(u)},guessLatHeader:k,guessLonHeader:y,csv:J.csvParse,tsv:J.tsvParse,dsv:J,auto:function(g){var I=X(g);return I?function(g){return delete g.columns,g}(J.dsvFormat(I).parse(g)):null},csv2geojson:function(g,I,C){C||(C=I,I={}),I.delimiter=I.delimiter||",";var A=I.latfield||"",l=I.lonfield||"",b=I.crs||"",c=[],o={type:"FeatureCollection",features:c};if(""!==b&&(o.crs={type:"name",properties:{name:b}}),"auto"!==I.delimiter||"string"!=typeof g||(I.delimiter=X(g),I.delimiter)){var Z=I.numericFields?I.numericFields.split(","):null,d="string"==typeof g?J.dsvFormat(I.delimiter).parse(g,(function(g){if(Z)for(var I in g)Z.includes(I)&&(g[I]=+g[I]);return g})):g;if(d.length){var G,n=[];if(A||(A=k(d[0])),l||(l=y(d[0])),!A||!l){for(G=0;G<d.length;G++)c.push({type:"Feature",properties:d[G],geometry:null});C(n.length?n:null,o)}else{for(G=0;G<d.length;G++)if(void 0!==d[G][l]&&void 0!==d[G][A]){var e,t,s,m=d[G][l],i=d[G][A];(s=a(m,"EW"))&&(m=s),(s=a(i,"NS"))&&(i=s),e=parseFloat(m),t=parseFloat(i),isNaN(e)||isNaN(t)?n.push({message:"A row contained an invalid value for latitude or longitude",row:d[G],index:G}):(I.includeLatLon||(delete d[G][l],delete d[G][A]),c.push({type:"Feature",properties:d[G],geometry:{type:"Point",coordinates:[parseFloat(e),parseFloat(t)]}}))}C(n.length?n:null,o)}}else C(null,o)}else C({type:"Error",message:"Could not autodetect delimiter"})},toLine:function(g){for(var I=g.features,C={type:"Feature",geometry:{type:"LineString",coordinates:[]}},A=0;A<I.length;A++)C.geometry.coordinates.push(I[A].geometry.coordinates);return C.properties=I.reduce((function(g,I){for(var C in I.properties)g[C]||(g[C]=[]),g[C].push(I.properties[C]);return g}),{}),{type:"FeatureCollection",features:[C]}},toPolygon:function(g){for(var I=g.features,C={type:"Feature",geometry:{type:"Polygon",coordinates:[[]]}},A=0;A<I.length;A++)C.geometry.coordinates[0].push(I[A].geometry.coordinates);return C.properties=I.reduce((function(g,I){for(var C in I.properties)g[C]||(g[C]=[]),g[C].push(I.properties[C]);return g}),{}),{type:"FeatureCollection",features:[C]}}};function p(g){return g}function H(g,I){var C=I.id,A=I.bbox,l=null==I.properties?{}:I.properties,b=function(g,I){var C=function(g){if(null==g)return p;var I,C,A=g.scale[0],l=g.scale[1],b=g.translate[0],c=g.translate[1];return function(g,o){o||(I=C=0);var Z=2,d=g.length,G=new Array(d);for(G[0]=(I+=g[0])*A+b,G[1]=(C+=g[1])*l+c;Z<d;)G[Z]=g[Z],++Z;return G}}(g.transform),A=g.arcs;function l(g,I){I.length&&I.pop();for(var l=A[g<0?~g:g],b=0,c=l.length;b<c;++b)I.push(C(l[b],b));g<0&&function(g,I){for(var C,A=g.length,l=A-I;l<--A;)C=g[l],g[l++]=g[A],g[A]=C}(I,c)}function b(g){return C(g)}function c(g){for(var I=[],C=0,A=g.length;C<A;++C)l(g[C],I);return I.length<2&&I.push(I[0]),I}function o(g){for(var I=c(g);I.length<4;)I.push(I[0]);return I}function Z(g){return g.map(o)}function d(g){var I,C=g.type;switch(C){case"GeometryCollection":return{type:C,geometries:g.geometries.map(d)};case"Point":I=b(g.coordinates);break;case"MultiPoint":I=g.coordinates.map(b);break;case"LineString":I=c(g.arcs);break;case"MultiLineString":I=g.arcs.map(c);break;case"Polygon":I=Z(g.arcs);break;case"MultiPolygon":I=g.arcs.map(Z);break;default:return null}return{type:C,coordinates:I}}return d(I)}(g,I);return null==C&&null==A?{type:"Feature",properties:l,geometry:b}:null==A?{type:"Feature",id:C,properties:l,geometry:b}:{type:"Feature",id:C,bbox:A,properties:l,geometry:b}}function r(g,I){return Array.from(g.getElementsByTagName(I))}function R(g){return"#"===g[0]?g:`#${g}`}function Y(g){return g?.normalize(),g&&g.textContent||""}function w(g,I,C){const A=g.getElementsByTagName(I),l=A.length?A[0]:null;return l&&C&&C(l),l}function v(g,I,C){const A={};if(!g)return A;const l=g.getElementsByTagName(I),b=l.length?l[0]:null;return b&&C?C(b,A):A}function N(g,I,C){const A=Y(w(g,I));return A&&C&&C(A)||{}}function F(g,I,C){const A=parseFloat(Y(w(g,I)));if(!isNaN(A))return A&&C&&C(A)||{}}function z(g,I,C){const A=parseFloat(Y(w(g,I)));if(!isNaN(A))return A&&C&&C(A),A}function f(g,I){const C={};for(const A of I)N(g,A,(g=>{C[A]=g}));return C}function L(g){return 1===g?.nodeType}function x(g){return v(g,"line",(g=>Object.assign({},N(g,"color",(g=>({stroke:`#${g}`}))),F(g,"opacity",(g=>({"stroke-opacity":g}))),F(g,"width",(g=>({"stroke-width":96*g/25.4}))))))}function Q(g){let I=[];if(null===g)return I;for(const C of Array.from(g.childNodes)){if(!L(C))continue;const g=T(C.nodeName);if("gpxtpx:TrackPointExtension"===g)I=I.concat(Q(C));else{const A=Y(C);I.push([g,U(A)])}}return I}function T(g){return["heart","gpxtpx:hr","hr"].includes(g)?"heart":g}function U(g){const I=parseFloat(g);return isNaN(I)?g:I}function j(g){const I=[parseFloat(g.getAttribute("lon")||""),parseFloat(g.getAttribute("lat")||"")];if(isNaN(I[0])||isNaN(I[1]))return null;z(g,"ele",(g=>{I.push(g)}));const C=w(g,"time");return{coordinates:I,time:C?Y(C):null,extendedValues:Q(w(g,"extensions"))}}function O(g){const I=f(g,["name","cmt","desc","type","time","keywords"]),C=Array.from(g.getElementsByTagNameNS("http://www.garmin.com/xmlschemas/GpxExtensions/v3","*"));for(const A of C)A.parentNode?.parentNode===g&&(I[A.tagName.replace(":","_")]=Y(A));const A=r(g,"link");return A.length&&(I.links=A.map((g=>Object.assign({href:g.getAttribute("href")},f(g,["text","type"]))))),I}function M(g,I){const C=r(g,I),A=[],l=[],b={};for(let g=0;g<C.length;g++){const I=j(C[g]);if(I){A.push(I.coordinates),I.time&&l.push(I.time);for(const[A,l]of I.extendedValues){const I="heart"===A?A:A.replace("gpxtpx:","")+"s";b[I]||(b[I]=Array(C.length).fill(null)),b[I][g]=l}}}if(!(A.length<2))return{line:A,times:l,extendedValues:b}}function P(g){const I=M(g,"rtept");if(I)return{type:"Feature",properties:Object.assign({_gpxType:"rte"},O(g),x(w(g,"extensions"))),geometry:{type:"LineString",coordinates:I.line}}}function D(g){const I=r(g,"trkseg"),C=[],A=[],l=[];for(const g of I){const I=M(g,"trkpt");I&&(l.push(I),I.times&&I.times.length&&A.push(I.times))}if(0===l.length)return null;const b=l.length>1,c=Object.assign({_gpxType:"trk"},O(g),x(w(g,"extensions")),A.length?{coordinateProperties:{times:b?A:A[0]}}:{});for(const g of l){C.push(g.line),c.coordinateProperties||(c.coordinateProperties={});const I=c.coordinateProperties,A=Object.entries(g.extendedValues);for(let g=0;g<A.length;g++){const[C,c]=A[g];b?(I[C]||(I[C]=l.map((g=>new Array(g.line.length).fill(null)))),I[C][g]=c):I[C]=c}}return{type:"Feature",properties:c,geometry:b?{type:"MultiLineString",coordinates:C}:{type:"LineString",coordinates:C[0]}}}function E(g){const I=Object.assign(O(g),f(g,["sym"])),C=j(g);return C?{type:"Feature",properties:I,geometry:{type:"Point",coordinates:C.coordinates}}:null}function*q(g){for(const I of r(g,"trk")){const g=D(I);g&&(yield g)}for(const I of r(g,"rte")){const g=P(I);g&&(yield g)}for(const I of r(g,"wpt")){const g=E(I);g&&(yield g)}}const _="http://www.garmin.com/xmlschemas/ActivityExtension/v2",$=[["heartRate","heartRates"],["Cadence","cadences"],["Speed","speeds"],["Watts","watts"]],gg=[["TotalTimeSeconds","totalTimeSeconds"],["DistanceMeters","distanceMeters"],["MaximumSpeed","maxSpeed"],["AverageHeartRateBpm","avgHeartRate"],["MaximumHeartRateBpm","maxHeartRate"],["AvgSpeed","avgSpeed"],["AvgWatts","avgWatts"],["MaxWatts","maxWatts"]];function Ig(g,I){const C=[];for(const[A,l]of I){let I=w(g,A);if(!I){const C=g.getElementsByTagNameNS(_,A);C.length&&(I=C[0])}const b=parseFloat(Y(I));isNaN(b)||C.push([l,b])}return C}function Cg(g){const I=[z(g,"LongitudeDegrees"),z(g,"LatitudeDegrees")];if(void 0===I[0]||isNaN(I[0])||void 0===I[1]||isNaN(I[1]))return null;const C=w(g,"HeartRateBpm"),A=Y(w(g,"Time"));return w(g,"AltitudeMeters",(g=>{const C=parseFloat(Y(g));isNaN(C)||I.push(C)})),{coordinates:I,time:A||null,heartRate:C?parseFloat(Y(C)):null,extensions:Ig(g,$)}}function Ag(g){const I=r(g,"Trackpoint"),C=[],A=[],l=[];if(I.length<2)return null;const b={},c={extendedProperties:b};for(let g=0;g<I.length;g++){const c=Cg(I[g]);if(null===c)continue;C.push(c.coordinates);const{time:o,heartRate:Z,extensions:d}=c;o&&A.push(o),Z&&l.push(Z);for(const[C,A]of d)b[C]||(b[C]=Array(I.length).fill(null)),b[C][g]=A}return C.length<2?null:Object.assign(c,{line:C,times:A,heartRates:l})}function lg(g){const I=r(g,"Track"),C=[],A=[],l=[],b=[];let c;const o=Object.assign(Object.fromEntries(Ig(g,gg)),v(g,"Name",(g=>({name:Y(g)}))));for(const g of I)c=Ag(g),c&&(C.push(c.line),c.times.length&&A.push(c.times),c.heartRates.length&&l.push(c.heartRates),b.push(c.extendedProperties));for(let g=0;g<b.length;g++){const A=b[g];for(const l in A)1===I.length?c&&(o[l]=c.extendedProperties[l]):(o[l]||(o[l]=C.map((g=>Array(g.length).fill(null)))),o[l][g]=A[l])}return 0===C.length?null:((A.length||l.length)&&(o.coordinateProperties=Object.assign(A.length?{times:1===C.length?A[0]:A}:{},l.length?{heart:1===C.length?l[0]:l}:{})),{type:"Feature",properties:o,geometry:1===C.length?{type:"LineString",coordinates:C[0]}:{type:"MultiLineString",coordinates:C}})}function*bg(g){for(const I of r(g,"Lap")){const g=lg(I);g&&(yield g)}for(const I of r(g,"Courses")){const g=lg(I);g&&(yield g)}}function cg(g,I){const C={},A="stroke"==I||"fill"===I?I:I+"-color";return"#"===g[0]&&(g=g.substring(1)),6===g.length||3===g.length?C[A]="#"+g:8===g.length&&(C[I+"-opacity"]=parseInt(g.substring(0,2),16)/255,C[A]="#"+g.substring(6,8)+g.substring(4,6)+g.substring(2,4)),C}function og(g,I,C){const A={};return z(g,I,(g=>{A[C]=g})),A}function Zg(g,I){return v(g,"color",(g=>cg(Y(g),I)))}function dg(g){return v(g,"Icon",((g,I)=>(N(g,"href",(g=>{I.icon=g})),I)))}function Gg(g){return Object.assign({},function(g){return v(g,"PolyStyle",((g,I)=>Object.assign(I,v(g,"color",(g=>cg(Y(g),"fill"))),N(g,"fill",(g=>{if("0"===g)return{"fill-opacity":0}})),N(g,"outline",(g=>{if("0"===g)return{"stroke-opacity":0}})))))}(g),function(g){return v(g,"LineStyle",(g=>Object.assign(Zg(g,"stroke"),og(g,"width","stroke-width"))))}(g),function(g){return v(g,"LabelStyle",(g=>Object.assign(Zg(g,"label"),og(g,"scale","label-scale"))))}(g),function(g){return v(g,"IconStyle",(g=>Object.assign(Zg(g,"icon"),og(g,"scale","icon-scale"),og(g,"heading","icon-heading"),v(g,"hotSpot",(g=>{const I=parseFloat(g.getAttribute("x")||""),C=parseFloat(g.getAttribute("y")||""),A=g.getAttribute("xunits")||"",l=g.getAttribute("yunits")||"";return isNaN(I)||isNaN(C)?{}:{"icon-offset":[I,C],"icon-offset-units":[A,l]}})),dg(g))))}(g))}const ng=g=>Number(g),eg={string:g=>g,int:ng,uint:ng,short:ng,ushort:ng,float:ng,double:ng,bool:g=>Boolean(g)};function tg(g,I){return v(g,"ExtendedData",((g,C)=>{for(const I of r(g,"Data"))C[I.getAttribute("name")||""]=Y(w(I,"value"));for(const A of r(g,"SimpleData")){const g=A.getAttribute("name")||"",l=I[g]||eg.string;C[g]=l(Y(A))}return C}))}function sg(g){const I=w(g,"description");for(const g of Array.from(I?.childNodes||[]))if(4===g.nodeType)return{description:{"@type":"html",value:Y(g)}};return{}}function mg(g){return v(g,"TimeSpan",(g=>({timespan:{begin:Y(w(g,"begin")),end:Y(w(g,"end"))}})))}function ig(g){return v(g,"TimeStamp",(g=>({timestamp:Y(w(g,"when"))})))}function Bg(g,I){return N(g,"styleUrl",(g=>(g=R(g),I[g]?Object.assign({styleUrl:g},I[g]):{styleUrl:g})))}const Wg=/\s*/g,Jg=/^\s*|\s*$/g,ag=/\s+/;function ug(g){return g.replace(Wg,"").split(",").map(parseFloat).filter((g=>!isNaN(g))).slice(0,3)}function Sg(g){return g.replace(Jg,"").split(ag).map(ug).filter((g=>g.length>=2))}function Vg(g){let I=r(g,"coord");0===I.length&&(I=function(g,I,C){return Array.from(g.getElementsByTagNameNS(C,I))}(g,"coord","*"));const C=I.map((g=>Y(g).split(" ").map(parseFloat)));return 0===C.length?null:{geometry:C.length>2?{type:"LineString",coordinates:C}:{type:"Point",coordinates:C[0]},times:r(g,"when").map((g=>Y(g)))}}function kg(g){if(0===g.length)return g;const I=g[0],C=g[g.length-1];let A=!0;for(let g=0;g<Math.max(I.length,C.length);g++)if(I[g]!==C[g]){A=!1;break}return A?g:g.concat([g[0]])}function yg(g){return Y(w(g,"coordinates"))}function hg(g){let I=[],C=[];for(let A=0;A<g.childNodes.length;A++){const l=g.childNodes.item(A);if(L(l))switch(l.tagName){case"MultiGeometry":case"MultiTrack":case"gx:MultiTrack":{const g=hg(l);I=I.concat(g.geometries),C=C.concat(g.coordTimes);break}case"Point":{const g=ug(yg(l));g.length>=2&&I.push({type:"Point",coordinates:g});break}case"LinearRing":case"LineString":{const g=Sg(yg(l));g.length>=2&&I.push({type:"LineString",coordinates:g});break}case"Polygon":{const g=[];for(const I of r(l,"LinearRing")){const C=kg(Sg(yg(I)));C.length>=4&&g.push(C)}g.length&&I.push({type:"Polygon",coordinates:g});break}case"Track":case"gx:Track":{const g=Vg(l);if(!g)break;const{times:A,geometry:b}=g;I.push(b),A.length&&C.push(A);break}}}return{geometries:I,coordTimes:C}}function Xg(g){return 0===g.length?null:1===g.length?g[0]:{type:"GeometryCollection",geometries:g}}function Kg(g,I,C){const{coordTimes:A,geometries:l}=hg(g),b={type:"Feature",geometry:Xg(l),properties:Object.assign(f(g,["name","address","visibility","open","phoneNumber","description"]),sg(g),Bg(g,I),Gg(g),tg(g,C),mg(g),ig(g),A.length?{coordinateProperties:{times:1===A.length?A[0]:A}}:{})};void 0!==b.properties?.visibility&&(b.properties.visibility="0"!==b.properties.visibility);const c=g.getAttribute("id");return null!==c&&""!==c&&(b.id=c),b}function pg(g){if(w(g,"gx:LatLonQuad")){return{type:"Polygon",coordinates:[kg(Sg(yg(g)))]}}return function(g){const I=w(g,"LatLonBox");if(I){const g=z(I,"north"),C=z(I,"west"),A=z(I,"east"),l=z(I,"south"),b=z(I,"rotation");if("number"==typeof g&&"number"==typeof l&&"number"==typeof C&&"number"==typeof A){let I=[[[C,g],[A,g],[A,l],[C,l],[C,g]]];return"number"==typeof b&&(I=function(g,I,C){const A=[(g[0]+g[2])/2,(g[1]+g[3])/2];return[I[0].map((g=>{const I=g[1]-A[1],l=g[0]-A[0],b=Math.sqrt(Math.pow(I,2)+Math.pow(l,2)),c=Math.atan2(I,l)-C*Hg;return[A[0]+Math.cos(c)*b,A[1]+Math.sin(c)*b]}))]}([C,l,A,g],I,b)),{type:"Polygon",coordinates:I}}}return null}(g)}const Hg=Math.PI/180;function rg(g,I,C){const A={type:"Feature",geometry:pg(g),properties:Object.assign({"@geometry-type":"groundoverlay"},f(g,["name","address","visibility","open","phoneNumber","description"]),sg(g),Bg(g,I),Gg(g),dg(g),tg(g,C),mg(g),ig(g))};void 0!==A.properties?.visibility&&(A.properties.visibility="0"!==A.properties.visibility);const l=g.getAttribute("id");return null!==l&&""!==l&&(A.id=l),A}function Rg(g){let I=g.getAttribute("id");const C=g.parentNode;return!I&&L(C)&&"CascadingStyle"===C.localName&&(I=C.getAttribute("kml:id")||C.getAttribute("id")),R(I||"")}function Yg(g){const I={};for(const C of r(g,"Style"))I[Rg(C)]=Gg(C);for(const C of r(g,"StyleMap")){const g=R(C.getAttribute("id")||"");N(C,"styleUrl",(C=>{C=R(C),I[C]&&(I[g]=I[C])}))}return I}function wg(g){const I={};for(const C of r(g,"SimpleField"))I[C.getAttribute("name")||""]=eg[C.getAttribute("type")||""]||eg.string;return I}const vg=["name","visibility","open","address","description","phoneNumber","visibility"];function*Ng(g){const I=Yg(g),C=wg(g);for(const A of r(g,"Placemark")){const g=Kg(A,I,C);g&&(yield g)}for(const A of r(g,"GroundOverlay")){const g=rg(A,I,C);g&&(yield g)}}var Fg=Object.freeze({__proto__:null,gpx:function(g){return{type:"FeatureCollection",features:Array.from(q(g))}},gpxGen:q,kml:function(g){return{type:"FeatureCollection",features:Array.from(Ng(g))}},kmlGen:Ng,kmlWithFolders:function(g){const I=Yg(g),C=wg(g),A={type:"root",children:[]};return function g(A,l){if(L(A))switch(A.tagName){case"GroundOverlay":{const g=rg(A,I,C);g&&l.children.push(g);break}case"Placemark":{const g=Kg(A,I,C);g&&l.children.push(g);break}case"Folder":{const g=function(g){const I={};for(const C of Array.from(g.childNodes))L(C)&&vg.includes(C.tagName)&&(I[C.tagName]=Y(C));return{type:"folder",meta:I,children:[]}}(A);l.children.push(g),l=g;break}}if(A.childNodes)for(let I=0;I<A.childNodes.length;I++)g(A.childNodes[I],l)}(g,A),A},tcx:function(g){return{type:"FeatureCollection",features:Array.from(bg(g))}},tcxGen:bg});const zg=["topojson","kml","gpx","tcx","csv","tsv"];class fg{constructor(g,I){this.blankGeoJSON=()=>({type:"FeatureCollection",features:[]}),this._rawData=I,this._format=g;const C={topojson:this.loadTopoJson,kml:this.loadXml,gpx:this.loadXml,tcx:this.loadXml,csv:this.loadCsv,tsv:this.loadCsv};this._conversionFn=C[g]}async convert(){return this._conversionFn?this._conversionFn():new Promise(((g,I)=>I(`No converter exists for ${this._format}`)))}async loadXml(){return Fg[this._format]((new DOMParser).parseFromString(this._rawData,"text/xml"))}async loadCsv(){let g={};"tsv"===this._format&&(g.delimiter="\t");return await new Promise(((I,C)=>{K.csv2geojson(this._rawData,g,((g,A)=>{g?C(g):I(A)}))}))}async loadTopoJson(){let g={};try{g=JSON.parse(this._rawData)}catch(g){throw"Invalid TopoJson"}let I=this.blankGeoJSON();return"Topology"===g.type&&void 0!==g.objects&&(I={type:"FeatureCollection",features:I.features=Object.keys(g.objects).map((I=>{return C=g,"string"==typeof(A=I)&&(A=C.objects[A]),"GeometryCollection"===A.type?{type:"FeatureCollection",features:A.geometries.map((function(g){return H(C,g)}))}:H(C,A);var C,A})).reduce(((g,I)=>[...g,...I.features]),[])}),I}}var Lg=null;try{var xg="undefined"!=typeof module&&"function"==typeof module.require&&module.require("worker_threads")||"function"==typeof __non_webpack_require__&&__non_webpack_require__("worker_threads")||"function"==typeof require&&require("worker_threads");Lg=xg.Worker}catch(g){}function Qg(g,I,C){var A=void 0===I?null:I,l=function(g,I){return Buffer.from(g,"base64").toString(I?"utf16":"utf8")}(g,void 0!==C&&C),b=l.indexOf("\n",10)+1,c=l.substring(b)+(A?"//# sourceMappingURL="+A:"");return function(g){return new Lg(c,Object.assign({},g,{eval:!0}))}}function Tg(g,I,C){var A=void 0===I?null:I,l=function(g,I){var C=atob(g);if(I){for(var A=new Uint8Array(C.length),l=0,b=C.length;l<b;++l)A[l]=C.charCodeAt(l);return String.fromCharCode.apply(null,new Uint16Array(A.buffer))}return C}(g,void 0!==C&&C),b=l.indexOf("\n",10)+1,c=l.substring(b)+(A?"//# sourceMappingURL="+A:""),o=new Blob([c],{type:"application/javascript"});return URL.createObjectURL(o)}var Ug="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0);var jg,Og,Mg,Pg=(jg="Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwooZnVuY3Rpb24gKCkgewoJJ3VzZSBzdHJpY3QnOwoKCWZ1bmN0aW9uIGdldEF1Z21lbnRlZE5hbWVzcGFjZShuKSB7CgkgIGlmIChuLl9fZXNNb2R1bGUpIHJldHVybiBuOwoJICB2YXIgZiA9IG4uZGVmYXVsdDsKCQlpZiAodHlwZW9mIGYgPT0gImZ1bmN0aW9uIikgewoJCQl2YXIgYSA9IGZ1bmN0aW9uIGEgKCkgewoJCQkJaWYgKHRoaXMgaW5zdGFuY2VvZiBhKSB7CgkJCQkJdmFyIGFyZ3MgPSBbbnVsbF07CgkJCQkJYXJncy5wdXNoLmFwcGx5KGFyZ3MsIGFyZ3VtZW50cyk7CgkJCQkJdmFyIEN0b3IgPSBGdW5jdGlvbi5iaW5kLmFwcGx5KGYsIGFyZ3MpOwoJCQkJCXJldHVybiBuZXcgQ3RvcigpOwoJCQkJfQoJCQkJcmV0dXJuIGYuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCQkJfTsKCQkJYS5wcm90b3R5cGUgPSBmLnByb3RvdHlwZTsKCSAgfSBlbHNlIGEgPSB7fTsKCSAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGEsICdfX2VzTW9kdWxlJywge3ZhbHVlOiB0cnVlfSk7CgkJT2JqZWN0LmtleXMobikuZm9yRWFjaChmdW5jdGlvbiAoaykgewoJCQl2YXIgZCA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iobiwgayk7CgkJCU9iamVjdC5kZWZpbmVQcm9wZXJ0eShhLCBrLCBkLmdldCA/IGQgOiB7CgkJCQllbnVtZXJhYmxlOiB0cnVlLAoJCQkJZ2V0OiBmdW5jdGlvbiAoKSB7CgkJCQkJcmV0dXJuIG5ba107CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiBhOwoJfQoKCWZ1bmN0aW9uIG9iamVjdENvbnZlcnRlcihjb2x1bW5zKSB7CgkgIHJldHVybiBuZXcgRnVuY3Rpb24oImQiLCAicmV0dXJuIHsiICsgY29sdW1ucy5tYXAoZnVuY3Rpb24obmFtZSwgaSkgewoJICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShuYW1lKSArICI6IGRbIiArIGkgKyAiXSI7CgkgIH0pLmpvaW4oIiwiKSArICJ9Iik7Cgl9CgoJZnVuY3Rpb24gY3VzdG9tQ29udmVydGVyKGNvbHVtbnMsIGYpIHsKCSAgdmFyIG9iamVjdCA9IG9iamVjdENvbnZlcnRlcihjb2x1bW5zKTsKCSAgcmV0dXJuIGZ1bmN0aW9uKHJvdywgaSkgewoJICAgIHJldHVybiBmKG9iamVjdChyb3cpLCBpLCBjb2x1bW5zKTsKCSAgfTsKCX0KCgkvLyBDb21wdXRlIHVuaXF1ZSBjb2x1bW5zIGluIG9yZGVyIG9mIGRpc2NvdmVyeS4KCWZ1bmN0aW9uIGluZmVyQ29sdW1ucyhyb3dzKSB7CgkgIHZhciBjb2x1bW5TZXQgPSBPYmplY3QuY3JlYXRlKG51bGwpLAoJICAgICAgY29sdW1ucyA9IFtdOwoKCSAgcm93cy5mb3JFYWNoKGZ1bmN0aW9uKHJvdykgewoJICAgIGZvciAodmFyIGNvbHVtbiBpbiByb3cpIHsKCSAgICAgIGlmICghKGNvbHVtbiBpbiBjb2x1bW5TZXQpKSB7CgkgICAgICAgIGNvbHVtbnMucHVzaChjb2x1bW5TZXRbY29sdW1uXSA9IGNvbHVtbik7CgkgICAgICB9CgkgICAgfQoJICB9KTsKCgkgIHJldHVybiBjb2x1bW5zOwoJfQoKCWZ1bmN0aW9uIGRzdiQxKGRlbGltaXRlcikgewoJICB2YXIgcmVGb3JtYXQgPSBuZXcgUmVnRXhwKCJbXCIiICsgZGVsaW1pdGVyICsgIlxuXSIpLAoJICAgICAgZGVsaW1pdGVyQ29kZSA9IGRlbGltaXRlci5jaGFyQ29kZUF0KDApOwoKCSAgZnVuY3Rpb24gcGFyc2UodGV4dCwgZikgewoJICAgIHZhciBjb252ZXJ0LCBjb2x1bW5zLCByb3dzID0gcGFyc2VSb3dzKHRleHQsIGZ1bmN0aW9uKHJvdywgaSkgewoJICAgICAgaWYgKGNvbnZlcnQpIHJldHVybiBjb252ZXJ0KHJvdywgaSAtIDEpOwoJICAgICAgY29sdW1ucyA9IHJvdywgY29udmVydCA9IGYgPyBjdXN0b21Db252ZXJ0ZXIocm93LCBmKSA6IG9iamVjdENvbnZlcnRlcihyb3cpOwoJICAgIH0pOwoJICAgIHJvd3MuY29sdW1ucyA9IGNvbHVtbnM7CgkgICAgcmV0dXJuIHJvd3M7CgkgIH0KCgkgIGZ1bmN0aW9uIHBhcnNlUm93cyh0ZXh0LCBmKSB7CgkgICAgdmFyIEVPTCA9IHt9LCAvLyBzZW50aW5lbCB2YWx1ZSBmb3IgZW5kLW9mLWxpbmUKCSAgICAgICAgRU9GID0ge30sIC8vIHNlbnRpbmVsIHZhbHVlIGZvciBlbmQtb2YtZmlsZQoJICAgICAgICByb3dzID0gW10sIC8vIG91dHB1dCByb3dzCgkgICAgICAgIE4gPSB0ZXh0Lmxlbmd0aCwKCSAgICAgICAgSSA9IDAsIC8vIGN1cnJlbnQgY2hhcmFjdGVyIGluZGV4CgkgICAgICAgIG4gPSAwLCAvLyB0aGUgY3VycmVudCBsaW5lIG51bWJlcgoJICAgICAgICB0LCAvLyB0aGUgY3VycmVudCB0b2tlbgoJICAgICAgICBlb2w7IC8vIGlzIHRoZSBjdXJyZW50IHRva2VuIGZvbGxvd2VkIGJ5IEVPTD8KCgkgICAgZnVuY3Rpb24gdG9rZW4oKSB7CgkgICAgICBpZiAoSSA+PSBOKSByZXR1cm4gRU9GOyAvLyBzcGVjaWFsIGNhc2U6IGVuZCBvZiBmaWxlCgkgICAgICBpZiAoZW9sKSByZXR1cm4gZW9sID0gZmFsc2UsIEVPTDsgLy8gc3BlY2lhbCBjYXNlOiBlbmQgb2YgbGluZQoKCSAgICAgIC8vIHNwZWNpYWwgY2FzZTogcXVvdGVzCgkgICAgICB2YXIgaiA9IEksIGM7CgkgICAgICBpZiAodGV4dC5jaGFyQ29kZUF0KGopID09PSAzNCkgewoJICAgICAgICB2YXIgaSA9IGo7CgkgICAgICAgIHdoaWxlIChpKysgPCBOKSB7CgkgICAgICAgICAgaWYgKHRleHQuY2hhckNvZGVBdChpKSA9PT0gMzQpIHsKCSAgICAgICAgICAgIGlmICh0ZXh0LmNoYXJDb2RlQXQoaSArIDEpICE9PSAzNCkgYnJlYWs7CgkgICAgICAgICAgICArK2k7CgkgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgICAgIEkgPSBpICsgMjsKCSAgICAgICAgYyA9IHRleHQuY2hhckNvZGVBdChpICsgMSk7CgkgICAgICAgIGlmIChjID09PSAxMykgewoJICAgICAgICAgIGVvbCA9IHRydWU7CgkgICAgICAgICAgaWYgKHRleHQuY2hhckNvZGVBdChpICsgMikgPT09IDEwKSArK0k7CgkgICAgICAgIH0gZWxzZSBpZiAoYyA9PT0gMTApIHsKCSAgICAgICAgICBlb2wgPSB0cnVlOwoJICAgICAgICB9CgkgICAgICAgIHJldHVybiB0ZXh0LnNsaWNlKGogKyAxLCBpKS5yZXBsYWNlKC8iIi9nLCAiXCIiKTsKCSAgICAgIH0KCgkgICAgICAvLyBjb21tb24gY2FzZTogZmluZCBuZXh0IGRlbGltaXRlciBvciBuZXdsaW5lCgkgICAgICB3aGlsZSAoSSA8IE4pIHsKCSAgICAgICAgdmFyIGsgPSAxOwoJICAgICAgICBjID0gdGV4dC5jaGFyQ29kZUF0KEkrKyk7CgkgICAgICAgIGlmIChjID09PSAxMCkgZW9sID0gdHJ1ZTsgLy8gXG4KCSAgICAgICAgZWxzZSBpZiAoYyA9PT0gMTMpIHsgZW9sID0gdHJ1ZTsgaWYgKHRleHQuY2hhckNvZGVBdChJKSA9PT0gMTApICsrSSwgKytrOyB9IC8vIFxyfFxyXG4KCSAgICAgICAgZWxzZSBpZiAoYyAhPT0gZGVsaW1pdGVyQ29kZSkgY29udGludWU7CgkgICAgICAgIHJldHVybiB0ZXh0LnNsaWNlKGosIEkgLSBrKTsKCSAgICAgIH0KCgkgICAgICAvLyBzcGVjaWFsIGNhc2U6IGxhc3QgdG9rZW4gYmVmb3JlIEVPRgoJICAgICAgcmV0dXJuIHRleHQuc2xpY2Uoaik7CgkgICAgfQoKCSAgICB3aGlsZSAoKHQgPSB0b2tlbigpKSAhPT0gRU9GKSB7CgkgICAgICB2YXIgYSA9IFtdOwoJICAgICAgd2hpbGUgKHQgIT09IEVPTCAmJiB0ICE9PSBFT0YpIHsKCSAgICAgICAgYS5wdXNoKHQpOwoJICAgICAgICB0ID0gdG9rZW4oKTsKCSAgICAgIH0KCSAgICAgIGlmIChmICYmIChhID0gZihhLCBuKyspKSA9PSBudWxsKSBjb250aW51ZTsKCSAgICAgIHJvd3MucHVzaChhKTsKCSAgICB9CgoJICAgIHJldHVybiByb3dzOwoJICB9CgoJICBmdW5jdGlvbiBmb3JtYXQocm93cywgY29sdW1ucykgewoJICAgIGlmIChjb2x1bW5zID09IG51bGwpIGNvbHVtbnMgPSBpbmZlckNvbHVtbnMocm93cyk7CgkgICAgcmV0dXJuIFtjb2x1bW5zLm1hcChmb3JtYXRWYWx1ZSkuam9pbihkZWxpbWl0ZXIpXS5jb25jYXQocm93cy5tYXAoZnVuY3Rpb24ocm93KSB7CgkgICAgICByZXR1cm4gY29sdW1ucy5tYXAoZnVuY3Rpb24oY29sdW1uKSB7CgkgICAgICAgIHJldHVybiBmb3JtYXRWYWx1ZShyb3dbY29sdW1uXSk7CgkgICAgICB9KS5qb2luKGRlbGltaXRlcik7CgkgICAgfSkpLmpvaW4oIlxuIik7CgkgIH0KCgkgIGZ1bmN0aW9uIGZvcm1hdFJvd3Mocm93cykgewoJICAgIHJldHVybiByb3dzLm1hcChmb3JtYXRSb3cpLmpvaW4oIlxuIik7CgkgIH0KCgkgIGZ1bmN0aW9uIGZvcm1hdFJvdyhyb3cpIHsKCSAgICByZXR1cm4gcm93Lm1hcChmb3JtYXRWYWx1ZSkuam9pbihkZWxpbWl0ZXIpOwoJICB9CgoJICBmdW5jdGlvbiBmb3JtYXRWYWx1ZSh0ZXh0KSB7CgkgICAgcmV0dXJuIHRleHQgPT0gbnVsbCA/ICIiCgkgICAgICAgIDogcmVGb3JtYXQudGVzdCh0ZXh0ICs9ICIiKSA/ICJcIiIgKyB0ZXh0LnJlcGxhY2UoL1wiL2csICJcIlwiIikgKyAiXCIiCgkgICAgICAgIDogdGV4dDsKCSAgfQoKCSAgcmV0dXJuIHsKCSAgICBwYXJzZTogcGFyc2UsCgkgICAgcGFyc2VSb3dzOiBwYXJzZVJvd3MsCgkgICAgZm9ybWF0OiBmb3JtYXQsCgkgICAgZm9ybWF0Um93czogZm9ybWF0Um93cwoJICB9OwoJfQoKCXZhciBjc3YgPSBkc3YkMSgiLCIpOwoKCXZhciBjc3ZQYXJzZSA9IGNzdi5wYXJzZTsKCXZhciBjc3ZQYXJzZVJvd3MgPSBjc3YucGFyc2VSb3dzOwoJdmFyIGNzdkZvcm1hdCA9IGNzdi5mb3JtYXQ7Cgl2YXIgY3N2Rm9ybWF0Um93cyA9IGNzdi5mb3JtYXRSb3dzOwoKCXZhciB0c3YgPSBkc3YkMSgiXHQiKTsKCgl2YXIgdHN2UGFyc2UgPSB0c3YucGFyc2U7Cgl2YXIgdHN2UGFyc2VSb3dzID0gdHN2LnBhcnNlUm93czsKCXZhciB0c3ZGb3JtYXQgPSB0c3YuZm9ybWF0OwoJdmFyIHRzdkZvcm1hdFJvd3MgPSB0c3YuZm9ybWF0Um93czsKCgl2YXIgZDNEc3YgPSAvKiNfX1BVUkVfXyovT2JqZWN0LmZyZWV6ZSh7CgkJX19wcm90b19fOiBudWxsLAoJCWRzdkZvcm1hdDogZHN2JDEsCgkJY3N2UGFyc2U6IGNzdlBhcnNlLAoJCWNzdlBhcnNlUm93czogY3N2UGFyc2VSb3dzLAoJCWNzdkZvcm1hdDogY3N2Rm9ybWF0LAoJCWNzdkZvcm1hdFJvd3M6IGNzdkZvcm1hdFJvd3MsCgkJdHN2UGFyc2U6IHRzdlBhcnNlLAoJCXRzdlBhcnNlUm93czogdHN2UGFyc2VSb3dzLAoJCXRzdkZvcm1hdDogdHN2Rm9ybWF0LAoJCXRzdkZvcm1hdFJvd3M6IHRzdkZvcm1hdFJvd3MKCX0pOwoKCXZhciByZXF1aXJlJCQwID0gLypAX19QVVJFX18qL2dldEF1Z21lbnRlZE5hbWVzcGFjZShkM0Rzdik7CgoJdmFyIHNleGFnZXNpbWFsRXhwb3J0cyA9IHt9OwoJdmFyIHNleGFnZXNpbWFsJDEgPSB7CgkgIGdldCBleHBvcnRzKCl7IHJldHVybiBzZXhhZ2VzaW1hbEV4cG9ydHM7IH0sCgkgIHNldCBleHBvcnRzKHYpeyBzZXhhZ2VzaW1hbEV4cG9ydHMgPSB2OyB9LAoJfTsKCglzZXhhZ2VzaW1hbCQxLmV4cG9ydHMgPSBlbGVtZW50OwoJc2V4YWdlc2ltYWxFeHBvcnRzLnBhaXIgPSBwYWlyOwoJc2V4YWdlc2ltYWxFeHBvcnRzLmZvcm1hdCA9IGZvcm1hdDsKCXNleGFnZXNpbWFsRXhwb3J0cy5mb3JtYXRQYWlyID0gZm9ybWF0UGFpcjsKCXNleGFnZXNpbWFsRXhwb3J0cy5jb29yZFRvRE1TID0gY29vcmRUb0RNUzsKCgoJZnVuY3Rpb24gZWxlbWVudChpbnB1dCwgZGltcykgewoJICB2YXIgcmVzdWx0ID0gc2VhcmNoKGlucHV0LCBkaW1zKTsKCSAgcmV0dXJuIChyZXN1bHQgPT09IG51bGwpID8gbnVsbCA6IHJlc3VsdC52YWw7Cgl9CgoKCWZ1bmN0aW9uIGZvcm1hdFBhaXIoaW5wdXQpIHsKCSAgcmV0dXJuIGZvcm1hdChpbnB1dC5sYXQsICdsYXQnKSArICcgJyArIGZvcm1hdChpbnB1dC5sb24sICdsb24nKTsKCX0KCgoJLy8gSXMgMCBOb3J0aCBvciBTb3V0aD8KCWZ1bmN0aW9uIGZvcm1hdChpbnB1dCwgZGltKSB7CgkgIHZhciBkbXMgPSBjb29yZFRvRE1TKGlucHV0LCBkaW0pOwoJICByZXR1cm4gZG1zLndob2xlICsgJ8KwICcgKwoJICAgIChkbXMubWludXRlcyA/IGRtcy5taW51dGVzICsgJ1wnICcgOiAnJykgKwoJICAgIChkbXMuc2Vjb25kcyA/IGRtcy5zZWNvbmRzICsgJyIgJyA6ICcnKSArIGRtcy5kaXI7Cgl9CgoKCWZ1bmN0aW9uIGNvb3JkVG9ETVMoaW5wdXQsIGRpbSkgewoJICB2YXIgZGlycyA9IHsgbGF0OiBbJ04nLCAnUyddLCBsb246IFsnRScsICdXJ10gfVtkaW1dIHx8ICcnOwoJICB2YXIgZGlyID0gZGlyc1tpbnB1dCA+PSAwID8gMCA6IDFdOwoJICB2YXIgYWJzID0gTWF0aC5hYnMoaW5wdXQpOwoJICB2YXIgd2hvbGUgPSBNYXRoLmZsb29yKGFicyk7CgkgIHZhciBmcmFjdGlvbiA9IGFicyAtIHdob2xlOwoJICB2YXIgZnJhY3Rpb25NaW51dGVzID0gZnJhY3Rpb24gKiA2MDsKCSAgdmFyIG1pbnV0ZXMgPSBNYXRoLmZsb29yKGZyYWN0aW9uTWludXRlcyk7CgkgIHZhciBzZWNvbmRzID0gTWF0aC5mbG9vcigoZnJhY3Rpb25NaW51dGVzIC0gbWludXRlcykgKiA2MCk7CgoJICByZXR1cm4gewoJICAgIHdob2xlOiB3aG9sZSwKCSAgICBtaW51dGVzOiBtaW51dGVzLAoJICAgIHNlY29uZHM6IHNlY29uZHMsCgkgICAgZGlyOiBkaXIKCSAgfTsKCX0KCgoJZnVuY3Rpb24gc2VhcmNoKGlucHV0LCBkaW1zKSB7CgkgIGlmICghZGltcykgZGltcyA9ICdOU0VXJzsKCSAgaWYgKHR5cGVvZiBpbnB1dCAhPT0gJ3N0cmluZycpIHJldHVybiBudWxsOwoKCSAgaW5wdXQgPSBpbnB1dC50b1VwcGVyQ2FzZSgpOwoJICB2YXIgcmVnZXggPSAvXltcc1wsXSooW05TRVddKT9ccyooW1wtfFzigJR8XOKAlV0/WzAtOS5dKylbwrDCusuaXT9ccyooPzooWzAtOS5dKylbJ+KAmeKAsuKAmF1ccyopPyg/OihbMC05Ll0rKSg/OicnfCJ84oCdfOKAsylccyopPyhbTlNFV10pPy87CgoJICB2YXIgbSA9IGlucHV0Lm1hdGNoKHJlZ2V4KTsKCSAgaWYgKCFtKSByZXR1cm4gbnVsbDsgIC8vIG5vIG1hdGNoCgoJICB2YXIgbWF0Y2hlZCA9IG1bMF07CgoJICAvLyBleHRyYWN0IGRpbWVuc2lvbi4uIG1bMV0gPSBsZWFkaW5nLCBtWzVdID0gdHJhaWxpbmcKCSAgdmFyIGRpbTsKCSAgaWYgKG1bMV0gJiYgbVs1XSkgeyAgICAgICAgICAgICAgICAgLy8gaWYgbWF0Y2hlZCBib3RoLi4KCSAgICBkaW0gPSBtWzFdOyAgICAgICAgICAgICAgICAgICAgICAgLy8ga2VlcCBsZWFkaW5nCgkgICAgbWF0Y2hlZCA9IG1hdGNoZWQuc2xpY2UoMCwgLTEpOyAgIC8vIHJlbW92ZSB0cmFpbGluZyBkaW1lbnNpb24gZnJvbSBtYXRjaAoJICB9IGVsc2UgewoJICAgIGRpbSA9IG1bMV0gfHwgbVs1XTsKCSAgfQoKCSAgLy8gaWYgdW5yZWNvZ25pemVkIGRpbWVuc2lvbgoJICBpZiAoZGltICYmIGRpbXMuaW5kZXhPZihkaW0pID09PSAtMSkgcmV0dXJuIG51bGw7CgoJICAvLyBleHRyYWN0IERNUwoJICB2YXIgZGVnID0gbVsyXSA/IHBhcnNlRmxvYXQobVsyXSkgOiAwOwoJICB2YXIgbWluID0gbVszXSA/IHBhcnNlRmxvYXQobVszXSkgLyA2MCA6IDA7CgkgIHZhciBzZWMgPSBtWzRdID8gcGFyc2VGbG9hdChtWzRdKSAvIDM2MDAgOiAwOwoJICB2YXIgc2lnbiA9IChkZWcgPCAwKSA/IC0xIDogMTsKCSAgaWYgKGRpbSA9PT0gJ1MnIHx8IGRpbSA9PT0gJ1cnKSBzaWduICo9IC0xOwoKCSAgcmV0dXJuIHsKCSAgICB2YWw6IChNYXRoLmFicyhkZWcpICsgbWluICsgc2VjKSAqIHNpZ24sCgkgICAgZGltOiBkaW0sCgkgICAgbWF0Y2hlZDogbWF0Y2hlZCwKCSAgICByZW1haW46IGlucHV0LnNsaWNlKG1hdGNoZWQubGVuZ3RoKQoJICB9OwoJfQoKCglmdW5jdGlvbiBwYWlyKGlucHV0LCBkaW1zKSB7CgkgIGlucHV0ID0gaW5wdXQudHJpbSgpOwoJICB2YXIgb25lID0gc2VhcmNoKGlucHV0LCBkaW1zKTsKCSAgaWYgKCFvbmUpIHJldHVybiBudWxsOwoKCSAgaW5wdXQgPSBvbmUucmVtYWluLnRyaW0oKTsKCSAgdmFyIHR3byA9IHNlYXJjaChpbnB1dCwgZGltcyk7CgkgIGlmICghdHdvIHx8IHR3by5yZW1haW4pIHJldHVybiBudWxsOwoKCSAgaWYgKG9uZS5kaW0pIHsKCSAgICByZXR1cm4gc3dhcGRpbShvbmUudmFsLCB0d28udmFsLCBvbmUuZGltKTsKCSAgfSBlbHNlIHsKCSAgICByZXR1cm4gW29uZS52YWwsIHR3by52YWxdOwoJICB9Cgl9CgoKCWZ1bmN0aW9uIHN3YXBkaW0oYSwgYiwgZGltKSB7CgkgIGlmIChkaW0gPT09ICdOJyB8fCBkaW0gPT09ICdTJykgcmV0dXJuIFthLCBiXTsKCSAgaWYgKGRpbSA9PT0gJ1cnIHx8IGRpbSA9PT0gJ0UnKSByZXR1cm4gW2IsIGFdOwoJfQoKCXZhciBkc3YgPSByZXF1aXJlJCQwLAoJICAgIHNleGFnZXNpbWFsID0gc2V4YWdlc2ltYWxFeHBvcnRzOwoKCXZhciBsYXRSZWdleCA9IC8oTGF0KShpdHVkZSk/L2dpLAoJICAgIGxvblJlZ2V4ID0gLyhMKShvbnxuZykoZ2l0dWRlKT8vaTsKCglmdW5jdGlvbiBndWVzc0hlYWRlcihyb3csIHJlZ2V4cCkgewoJICAgIHZhciBuYW1lLCBtYXRjaCwgc2NvcmU7CgkgICAgZm9yICh2YXIgZiBpbiByb3cpIHsKCSAgICAgICAgbWF0Y2ggPSBmLm1hdGNoKHJlZ2V4cCk7CgkgICAgICAgIGlmIChtYXRjaCAmJiAoIW5hbWUgfHwgbWF0Y2hbMF0ubGVuZ3RoIC8gZi5sZW5ndGggPiBzY29yZSkpIHsKCSAgICAgICAgICAgIHNjb3JlID0gbWF0Y2hbMF0ubGVuZ3RoIC8gZi5sZW5ndGg7CgkgICAgICAgICAgICBuYW1lID0gZjsKCSAgICAgICAgfQoJICAgIH0KCSAgICByZXR1cm4gbmFtZTsKCX0KCglmdW5jdGlvbiBndWVzc0xhdEhlYWRlcihyb3cpIHsgcmV0dXJuIGd1ZXNzSGVhZGVyKHJvdywgbGF0UmVnZXgpOyB9CglmdW5jdGlvbiBndWVzc0xvbkhlYWRlcihyb3cpIHsgcmV0dXJuIGd1ZXNzSGVhZGVyKHJvdywgbG9uUmVnZXgpOyB9CgoJZnVuY3Rpb24gaXNMYXQoZikgeyByZXR1cm4gISFmLm1hdGNoKGxhdFJlZ2V4KTsgfQoJZnVuY3Rpb24gaXNMb24oZikgeyByZXR1cm4gISFmLm1hdGNoKGxvblJlZ2V4KTsgfQoKCWZ1bmN0aW9uIGtleUNvdW50KG8pIHsKCSAgICByZXR1cm4gKHR5cGVvZiBvID09ICdvYmplY3QnKSA/IE9iamVjdC5rZXlzKG8pLmxlbmd0aCA6IDA7Cgl9CgoJZnVuY3Rpb24gYXV0b0RlbGltaXRlcih4KSB7CgkgICAgdmFyIGRlbGltaXRlcnMgPSBbJywnLCAnOycsICdcdCcsICd8J107CgkgICAgdmFyIHJlc3VsdHMgPSBbXTsKCgkgICAgZGVsaW1pdGVycy5mb3JFYWNoKGZ1bmN0aW9uIChkZWxpbWl0ZXIpIHsKCSAgICAgICAgdmFyIHJlcyA9IGRzdi5kc3ZGb3JtYXQoZGVsaW1pdGVyKS5wYXJzZSh4KTsKCSAgICAgICAgaWYgKHJlcy5sZW5ndGggPj0gMSkgewoJICAgICAgICAgICAgdmFyIGNvdW50ID0ga2V5Q291bnQocmVzWzBdKTsKCSAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVzLmxlbmd0aDsgaSsrKSB7CgkgICAgICAgICAgICAgICAgaWYgKGtleUNvdW50KHJlc1tpXSkgIT09IGNvdW50KSByZXR1cm47CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXN1bHRzLnB1c2goewoJICAgICAgICAgICAgICAgIGRlbGltaXRlcjogZGVsaW1pdGVyLAoJICAgICAgICAgICAgICAgIGFyaXR5OiBPYmplY3Qua2V5cyhyZXNbMF0pLmxlbmd0aCwKCSAgICAgICAgICAgIH0pOwoJICAgICAgICB9CgkgICAgfSk7CgoJICAgIGlmIChyZXN1bHRzLmxlbmd0aCkgewoJICAgICAgICByZXR1cm4gcmVzdWx0cy5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7CgkgICAgICAgICAgICByZXR1cm4gYi5hcml0eSAtIGEuYXJpdHk7CgkgICAgICAgIH0pWzBdLmRlbGltaXRlcjsKCSAgICB9IGVsc2UgewoJICAgICAgICByZXR1cm4gbnVsbDsKCSAgICB9Cgl9CgoJLyoqCgkgKiBTaWxseSBzdG9wZ2FwIGZvciBkc3YgdG8gZDMtZHN2IHVwZ3JhZGUKCSAqCgkgKiBAcGFyYW0ge0FycmF5fSB4IGRzdiBvdXRwdXQKCSAqIEByZXR1cm5zIHtBcnJheX0gYXJyYXkgd2l0aG91dCBjb2x1bW5zIG1lbWJlcgoJICovCglmdW5jdGlvbiBkZWxldGVDb2x1bW5zKHgpIHsKCSAgICBkZWxldGUgeC5jb2x1bW5zOwoJICAgIHJldHVybiB4OwoJfQoKCWZ1bmN0aW9uIGF1dG8oeCkgewoJICAgIHZhciBkZWxpbWl0ZXIgPSBhdXRvRGVsaW1pdGVyKHgpOwoJICAgIGlmICghZGVsaW1pdGVyKSByZXR1cm4gbnVsbDsKCSAgICByZXR1cm4gZGVsZXRlQ29sdW1ucyhkc3YuZHN2Rm9ybWF0KGRlbGltaXRlcikucGFyc2UoeCkpOwoJfQoKCWZ1bmN0aW9uIGNzdjJnZW9qc29uKHgsIG9wdGlvbnMsIGNhbGxiYWNrKSB7CgoJICAgIGlmICghY2FsbGJhY2spIHsKCSAgICAgICAgY2FsbGJhY2sgPSBvcHRpb25zOwoJICAgICAgICBvcHRpb25zID0ge307CgkgICAgfQoKCSAgICBvcHRpb25zLmRlbGltaXRlciA9IG9wdGlvbnMuZGVsaW1pdGVyIHx8ICcsJzsKCgkgICAgdmFyIGxhdGZpZWxkID0gb3B0aW9ucy5sYXRmaWVsZCB8fCAnJywKCSAgICAgICAgbG9uZmllbGQgPSBvcHRpb25zLmxvbmZpZWxkIHx8ICcnLAoJICAgICAgICBjcnMgPSBvcHRpb25zLmNycyB8fCAnJzsKCgkgICAgdmFyIGZlYXR1cmVzID0gW10sCgkgICAgICAgIGZlYXR1cmVjb2xsZWN0aW9uID0ge3R5cGU6ICdGZWF0dXJlQ29sbGVjdGlvbicsIGZlYXR1cmVzOiBmZWF0dXJlc307CgoJICAgIGlmIChjcnMgIT09ICcnKSB7CgkgICAgICAgIGZlYXR1cmVjb2xsZWN0aW9uLmNycyA9IHt0eXBlOiAnbmFtZScsIHByb3BlcnRpZXM6IHtuYW1lOiBjcnN9fTsKCSAgICB9CgoJICAgIGlmIChvcHRpb25zLmRlbGltaXRlciA9PT0gJ2F1dG8nICYmIHR5cGVvZiB4ID09ICdzdHJpbmcnKSB7CgkgICAgICAgIG9wdGlvbnMuZGVsaW1pdGVyID0gYXV0b0RlbGltaXRlcih4KTsKCSAgICAgICAgaWYgKCFvcHRpb25zLmRlbGltaXRlcikgewoJICAgICAgICAgICAgY2FsbGJhY2soewoJICAgICAgICAgICAgICAgIHR5cGU6ICdFcnJvcicsCgkgICAgICAgICAgICAgICAgbWVzc2FnZTogJ0NvdWxkIG5vdCBhdXRvZGV0ZWN0IGRlbGltaXRlcicKCSAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICB9CgkgICAgfQoKCSAgICB2YXIgbnVtZXJpY0ZpZWxkcyA9IG9wdGlvbnMubnVtZXJpY0ZpZWxkcyA/IG9wdGlvbnMubnVtZXJpY0ZpZWxkcy5zcGxpdCgnLCcpIDogbnVsbDsKCgkgICAgdmFyIHBhcnNlZCA9ICh0eXBlb2YgeCA9PSAnc3RyaW5nJykgPwoJICAgICAgICBkc3YuZHN2Rm9ybWF0KG9wdGlvbnMuZGVsaW1pdGVyKS5wYXJzZSh4LCBmdW5jdGlvbiAoZCkgewoJICAgICAgICAgICAgaWYgKG51bWVyaWNGaWVsZHMpIHsKCSAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gZCkgewoJICAgICAgICAgICAgICAgICAgICBpZiAobnVtZXJpY0ZpZWxkcy5pbmNsdWRlcyhrZXkpKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBkW2tleV0gPSArZFtrZXldOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIGQ7CgkgICAgICAgIH0pIDogeDsKCgkgICAgaWYgKCFwYXJzZWQubGVuZ3RoKSB7CgkgICAgICAgIGNhbGxiYWNrKG51bGwsIGZlYXR1cmVjb2xsZWN0aW9uKTsKCSAgICAgICAgcmV0dXJuOwoJICAgIH0KCgkgICAgdmFyIGVycm9ycyA9IFtdOwoJICAgIHZhciBpOwoKCgkgICAgaWYgKCFsYXRmaWVsZCkgbGF0ZmllbGQgPSBndWVzc0xhdEhlYWRlcihwYXJzZWRbMF0pOwoJICAgIGlmICghbG9uZmllbGQpIGxvbmZpZWxkID0gZ3Vlc3NMb25IZWFkZXIocGFyc2VkWzBdKTsKCSAgICB2YXIgbm9HZW9tZXRyeSA9ICghbGF0ZmllbGQgfHwgIWxvbmZpZWxkKTsKCgkgICAgaWYgKG5vR2VvbWV0cnkpIHsKCSAgICAgICAgZm9yIChpID0gMDsgaSA8IHBhcnNlZC5sZW5ndGg7IGkrKykgewoJICAgICAgICAgICAgZmVhdHVyZXMucHVzaCh7CgkgICAgICAgICAgICAgICAgdHlwZTogJ0ZlYXR1cmUnLAoJICAgICAgICAgICAgICAgIHByb3BlcnRpZXM6IHBhcnNlZFtpXSwKCSAgICAgICAgICAgICAgICBnZW9tZXRyeTogbnVsbAoJICAgICAgICAgICAgfSk7CgkgICAgICAgIH0KCSAgICAgICAgY2FsbGJhY2soZXJyb3JzLmxlbmd0aCA/IGVycm9ycyA6IG51bGwsIGZlYXR1cmVjb2xsZWN0aW9uKTsKCSAgICAgICAgcmV0dXJuOwoJICAgIH0KCgkgICAgZm9yIChpID0gMDsgaSA8IHBhcnNlZC5sZW5ndGg7IGkrKykgewoJICAgICAgICBpZiAocGFyc2VkW2ldW2xvbmZpZWxkXSAhPT0gdW5kZWZpbmVkICYmCgkgICAgICAgICAgICBwYXJzZWRbaV1bbGF0ZmllbGRdICE9PSB1bmRlZmluZWQpIHsKCgkgICAgICAgICAgICB2YXIgbG9uayA9IHBhcnNlZFtpXVtsb25maWVsZF0sCgkgICAgICAgICAgICAgICAgbGF0ayA9IHBhcnNlZFtpXVtsYXRmaWVsZF0sCgkgICAgICAgICAgICAgICAgbG9uZiwgbGF0ZiwKCSAgICAgICAgICAgICAgICBhOwoKCSAgICAgICAgICAgIGEgPSBzZXhhZ2VzaW1hbChsb25rLCAnRVcnKTsKCSAgICAgICAgICAgIGlmIChhKSBsb25rID0gYTsKCSAgICAgICAgICAgIGEgPSBzZXhhZ2VzaW1hbChsYXRrLCAnTlMnKTsKCSAgICAgICAgICAgIGlmIChhKSBsYXRrID0gYTsKCgkgICAgICAgICAgICBsb25mID0gcGFyc2VGbG9hdChsb25rKTsKCSAgICAgICAgICAgIGxhdGYgPSBwYXJzZUZsb2F0KGxhdGspOwoKCSAgICAgICAgICAgIGlmIChpc05hTihsb25mKSB8fAoJICAgICAgICAgICAgICAgIGlzTmFOKGxhdGYpKSB7CgkgICAgICAgICAgICAgICAgZXJyb3JzLnB1c2goewoJICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiAnQSByb3cgY29udGFpbmVkIGFuIGludmFsaWQgdmFsdWUgZm9yIGxhdGl0dWRlIG9yIGxvbmdpdHVkZScsCgkgICAgICAgICAgICAgICAgICAgIHJvdzogcGFyc2VkW2ldLAoJICAgICAgICAgICAgICAgICAgICBpbmRleDogaQoJICAgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICBpZiAoIW9wdGlvbnMuaW5jbHVkZUxhdExvbikgewoJICAgICAgICAgICAgICAgICAgICBkZWxldGUgcGFyc2VkW2ldW2xvbmZpZWxkXTsKCSAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHBhcnNlZFtpXVtsYXRmaWVsZF07CgkgICAgICAgICAgICAgICAgfQoKCSAgICAgICAgICAgICAgICBmZWF0dXJlcy5wdXNoKHsKCSAgICAgICAgICAgICAgICAgICAgdHlwZTogJ0ZlYXR1cmUnLAoJICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzOiBwYXJzZWRbaV0sCgkgICAgICAgICAgICAgICAgICAgIGdlb21ldHJ5OiB7CgkgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAnUG9pbnQnLAoJICAgICAgICAgICAgICAgICAgICAgICAgY29vcmRpbmF0ZXM6IFsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJzZUZsb2F0KGxvbmYpLAoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnNlRmxvYXQobGF0ZikKCSAgICAgICAgICAgICAgICAgICAgICAgIF0KCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgfQoKCSAgICBjYWxsYmFjayhlcnJvcnMubGVuZ3RoID8gZXJyb3JzIDogbnVsbCwgZmVhdHVyZWNvbGxlY3Rpb24pOwoJfQoKCWZ1bmN0aW9uIHRvTGluZShnaikgewoJICAgIHZhciBmZWF0dXJlcyA9IGdqLmZlYXR1cmVzOwoJICAgIHZhciBsaW5lID0gewoJICAgICAgICB0eXBlOiAnRmVhdHVyZScsCgkgICAgICAgIGdlb21ldHJ5OiB7CgkgICAgICAgICAgICB0eXBlOiAnTGluZVN0cmluZycsCgkgICAgICAgICAgICBjb29yZGluYXRlczogW10KCSAgICAgICAgfQoJICAgIH07CgkgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmZWF0dXJlcy5sZW5ndGg7IGkrKykgewoJICAgICAgICBsaW5lLmdlb21ldHJ5LmNvb3JkaW5hdGVzLnB1c2goZmVhdHVyZXNbaV0uZ2VvbWV0cnkuY29vcmRpbmF0ZXMpOwoJICAgIH0KCSAgICBsaW5lLnByb3BlcnRpZXMgPSBmZWF0dXJlcy5yZWR1Y2UoZnVuY3Rpb24gKGFnZ3JlZ2F0ZWRQcm9wZXJ0aWVzLCBuZXdGZWF0dXJlKSB7CgkgICAgICAgIGZvciAodmFyIGtleSBpbiBuZXdGZWF0dXJlLnByb3BlcnRpZXMpIHsKCSAgICAgICAgICAgIGlmICghYWdncmVnYXRlZFByb3BlcnRpZXNba2V5XSkgewoJICAgICAgICAgICAgICAgIGFnZ3JlZ2F0ZWRQcm9wZXJ0aWVzW2tleV0gPSBbXTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGFnZ3JlZ2F0ZWRQcm9wZXJ0aWVzW2tleV0ucHVzaChuZXdGZWF0dXJlLnByb3BlcnRpZXNba2V5XSk7CgkgICAgICAgIH0KCSAgICAgICAgcmV0dXJuIGFnZ3JlZ2F0ZWRQcm9wZXJ0aWVzOwoJICAgIH0sIHt9KTsKCSAgICByZXR1cm4gewoJICAgICAgICB0eXBlOiAnRmVhdHVyZUNvbGxlY3Rpb24nLAoJICAgICAgICBmZWF0dXJlczogW2xpbmVdCgkgICAgfTsKCX0KCglmdW5jdGlvbiB0b1BvbHlnb24oZ2opIHsKCSAgICB2YXIgZmVhdHVyZXMgPSBnai5mZWF0dXJlczsKCSAgICB2YXIgcG9seSA9IHsKCSAgICAgICAgdHlwZTogJ0ZlYXR1cmUnLAoJICAgICAgICBnZW9tZXRyeTogewoJICAgICAgICAgICAgdHlwZTogJ1BvbHlnb24nLAoJICAgICAgICAgICAgY29vcmRpbmF0ZXM6IFtbXV0KCSAgICAgICAgfQoJICAgIH07CgkgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmZWF0dXJlcy5sZW5ndGg7IGkrKykgewoJICAgICAgICBwb2x5Lmdlb21ldHJ5LmNvb3JkaW5hdGVzWzBdLnB1c2goZmVhdHVyZXNbaV0uZ2VvbWV0cnkuY29vcmRpbmF0ZXMpOwoJICAgIH0KCSAgICBwb2x5LnByb3BlcnRpZXMgPSBmZWF0dXJlcy5yZWR1Y2UoZnVuY3Rpb24gKGFnZ3JlZ2F0ZWRQcm9wZXJ0aWVzLCBuZXdGZWF0dXJlKSB7CgkgICAgICAgIGZvciAodmFyIGtleSBpbiBuZXdGZWF0dXJlLnByb3BlcnRpZXMpIHsKCSAgICAgICAgICAgIGlmICghYWdncmVnYXRlZFByb3BlcnRpZXNba2V5XSkgewoJICAgICAgICAgICAgICAgIGFnZ3JlZ2F0ZWRQcm9wZXJ0aWVzW2tleV0gPSBbXTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGFnZ3JlZ2F0ZWRQcm9wZXJ0aWVzW2tleV0ucHVzaChuZXdGZWF0dXJlLnByb3BlcnRpZXNba2V5XSk7CgkgICAgICAgIH0KCSAgICAgICAgcmV0dXJuIGFnZ3JlZ2F0ZWRQcm9wZXJ0aWVzOwoJICAgIH0sIHt9KTsKCSAgICByZXR1cm4gewoJICAgICAgICB0eXBlOiAnRmVhdHVyZUNvbGxlY3Rpb24nLAoJICAgICAgICBmZWF0dXJlczogW3BvbHldCgkgICAgfTsKCX0KCgl2YXIgY3N2Mmdlb2pzb25fMSA9IHsKCSAgICBpc0xvbjogaXNMb24sCgkgICAgaXNMYXQ6IGlzTGF0LAoJICAgIGd1ZXNzTGF0SGVhZGVyOiBndWVzc0xhdEhlYWRlciwKCSAgICBndWVzc0xvbkhlYWRlcjogZ3Vlc3NMb25IZWFkZXIsCgkgICAgY3N2OiBkc3YuY3N2UGFyc2UsCgkgICAgdHN2OiBkc3YudHN2UGFyc2UsCgkgICAgZHN2OiBkc3YsCgkgICAgYXV0bzogYXV0bywKCSAgICBjc3YyZ2VvanNvbjogY3N2Mmdlb2pzb24sCgkgICAgdG9MaW5lOiB0b0xpbmUsCgkgICAgdG9Qb2x5Z29uOiB0b1BvbHlnb24KCX07CgoJZnVuY3Rpb24gaWRlbnRpdHkoeCkgewoJICByZXR1cm4geDsKCX0KCglmdW5jdGlvbiB0cmFuc2Zvcm0odHJhbnNmb3JtKSB7CgkgIGlmICh0cmFuc2Zvcm0gPT0gbnVsbCkgcmV0dXJuIGlkZW50aXR5OwoJICB2YXIgeDAsCgkgICAgICB5MCwKCSAgICAgIGt4ID0gdHJhbnNmb3JtLnNjYWxlWzBdLAoJICAgICAga3kgPSB0cmFuc2Zvcm0uc2NhbGVbMV0sCgkgICAgICBkeCA9IHRyYW5zZm9ybS50cmFuc2xhdGVbMF0sCgkgICAgICBkeSA9IHRyYW5zZm9ybS50cmFuc2xhdGVbMV07CgkgIHJldHVybiBmdW5jdGlvbihpbnB1dCwgaSkgewoJICAgIGlmICghaSkgeDAgPSB5MCA9IDA7CgkgICAgdmFyIGogPSAyLCBuID0gaW5wdXQubGVuZ3RoLCBvdXRwdXQgPSBuZXcgQXJyYXkobik7CgkgICAgb3V0cHV0WzBdID0gKHgwICs9IGlucHV0WzBdKSAqIGt4ICsgZHg7CgkgICAgb3V0cHV0WzFdID0gKHkwICs9IGlucHV0WzFdKSAqIGt5ICsgZHk7CgkgICAgd2hpbGUgKGogPCBuKSBvdXRwdXRbal0gPSBpbnB1dFtqXSwgKytqOwoJICAgIHJldHVybiBvdXRwdXQ7CgkgIH07Cgl9CgoJZnVuY3Rpb24gcmV2ZXJzZShhcnJheSwgbikgewoJICB2YXIgdCwgaiA9IGFycmF5Lmxlbmd0aCwgaSA9IGogLSBuOwoJICB3aGlsZSAoaSA8IC0taikgdCA9IGFycmF5W2ldLCBhcnJheVtpKytdID0gYXJyYXlbal0sIGFycmF5W2pdID0gdDsKCX0KCglmdW5jdGlvbiB0b3BvanNvbkZlYXR1cmUodG9wb2xvZ3ksIG8pIHsKCSAgaWYgKHR5cGVvZiBvID09PSAic3RyaW5nIikgbyA9IHRvcG9sb2d5Lm9iamVjdHNbb107CgkgIHJldHVybiBvLnR5cGUgPT09ICJHZW9tZXRyeUNvbGxlY3Rpb24iCgkgICAgICA/IHt0eXBlOiAiRmVhdHVyZUNvbGxlY3Rpb24iLCBmZWF0dXJlczogby5nZW9tZXRyaWVzLm1hcChmdW5jdGlvbihvKSB7IHJldHVybiBmZWF0dXJlKHRvcG9sb2d5LCBvKTsgfSl9CgkgICAgICA6IGZlYXR1cmUodG9wb2xvZ3ksIG8pOwoJfQoKCWZ1bmN0aW9uIGZlYXR1cmUodG9wb2xvZ3ksIG8pIHsKCSAgdmFyIGlkID0gby5pZCwKCSAgICAgIGJib3ggPSBvLmJib3gsCgkgICAgICBwcm9wZXJ0aWVzID0gby5wcm9wZXJ0aWVzID09IG51bGwgPyB7fSA6IG8ucHJvcGVydGllcywKCSAgICAgIGdlb21ldHJ5ID0gb2JqZWN0KHRvcG9sb2d5LCBvKTsKCSAgcmV0dXJuIGlkID09IG51bGwgJiYgYmJveCA9PSBudWxsID8ge3R5cGU6ICJGZWF0dXJlIiwgcHJvcGVydGllczogcHJvcGVydGllcywgZ2VvbWV0cnk6IGdlb21ldHJ5fQoJICAgICAgOiBiYm94ID09IG51bGwgPyB7dHlwZTogIkZlYXR1cmUiLCBpZDogaWQsIHByb3BlcnRpZXM6IHByb3BlcnRpZXMsIGdlb21ldHJ5OiBnZW9tZXRyeX0KCSAgICAgIDoge3R5cGU6ICJGZWF0dXJlIiwgaWQ6IGlkLCBiYm94OiBiYm94LCBwcm9wZXJ0aWVzOiBwcm9wZXJ0aWVzLCBnZW9tZXRyeTogZ2VvbWV0cnl9OwoJfQoKCWZ1bmN0aW9uIG9iamVjdCh0b3BvbG9neSwgbykgewoJICB2YXIgdHJhbnNmb3JtUG9pbnQgPSB0cmFuc2Zvcm0odG9wb2xvZ3kudHJhbnNmb3JtKSwKCSAgICAgIGFyY3MgPSB0b3BvbG9neS5hcmNzOwoKCSAgZnVuY3Rpb24gYXJjKGksIHBvaW50cykgewoJICAgIGlmIChwb2ludHMubGVuZ3RoKSBwb2ludHMucG9wKCk7CgkgICAgZm9yICh2YXIgYSA9IGFyY3NbaSA8IDAgPyB+aSA6IGldLCBrID0gMCwgbiA9IGEubGVuZ3RoOyBrIDwgbjsgKytrKSB7CgkgICAgICBwb2ludHMucHVzaCh0cmFuc2Zvcm1Qb2ludChhW2tdLCBrKSk7CgkgICAgfQoJICAgIGlmIChpIDwgMCkgcmV2ZXJzZShwb2ludHMsIG4pOwoJICB9CgoJICBmdW5jdGlvbiBwb2ludChwKSB7CgkgICAgcmV0dXJuIHRyYW5zZm9ybVBvaW50KHApOwoJICB9CgoJICBmdW5jdGlvbiBsaW5lKGFyY3MpIHsKCSAgICB2YXIgcG9pbnRzID0gW107CgkgICAgZm9yICh2YXIgaSA9IDAsIG4gPSBhcmNzLmxlbmd0aDsgaSA8IG47ICsraSkgYXJjKGFyY3NbaV0sIHBvaW50cyk7CgkgICAgaWYgKHBvaW50cy5sZW5ndGggPCAyKSBwb2ludHMucHVzaChwb2ludHNbMF0pOyAvLyBUaGlzIHNob3VsZCBuZXZlciBoYXBwZW4gcGVyIHRoZSBzcGVjaWZpY2F0aW9uLgoJICAgIHJldHVybiBwb2ludHM7CgkgIH0KCgkgIGZ1bmN0aW9uIHJpbmcoYXJjcykgewoJICAgIHZhciBwb2ludHMgPSBsaW5lKGFyY3MpOwoJICAgIHdoaWxlIChwb2ludHMubGVuZ3RoIDwgNCkgcG9pbnRzLnB1c2gocG9pbnRzWzBdKTsgLy8gVGhpcyBtYXkgaGFwcGVuIGlmIGFuIGFyYyBoYXMgb25seSB0d28gcG9pbnRzLgoJICAgIHJldHVybiBwb2ludHM7CgkgIH0KCgkgIGZ1bmN0aW9uIHBvbHlnb24oYXJjcykgewoJICAgIHJldHVybiBhcmNzLm1hcChyaW5nKTsKCSAgfQoKCSAgZnVuY3Rpb24gZ2VvbWV0cnkobykgewoJICAgIHZhciB0eXBlID0gby50eXBlLCBjb29yZGluYXRlczsKCSAgICBzd2l0Y2ggKHR5cGUpIHsKCSAgICAgIGNhc2UgIkdlb21ldHJ5Q29sbGVjdGlvbiI6IHJldHVybiB7dHlwZTogdHlwZSwgZ2VvbWV0cmllczogby5nZW9tZXRyaWVzLm1hcChnZW9tZXRyeSl9OwoJICAgICAgY2FzZSAiUG9pbnQiOiBjb29yZGluYXRlcyA9IHBvaW50KG8uY29vcmRpbmF0ZXMpOyBicmVhazsKCSAgICAgIGNhc2UgIk11bHRpUG9pbnQiOiBjb29yZGluYXRlcyA9IG8uY29vcmRpbmF0ZXMubWFwKHBvaW50KTsgYnJlYWs7CgkgICAgICBjYXNlICJMaW5lU3RyaW5nIjogY29vcmRpbmF0ZXMgPSBsaW5lKG8uYXJjcyk7IGJyZWFrOwoJICAgICAgY2FzZSAiTXVsdGlMaW5lU3RyaW5nIjogY29vcmRpbmF0ZXMgPSBvLmFyY3MubWFwKGxpbmUpOyBicmVhazsKCSAgICAgIGNhc2UgIlBvbHlnb24iOiBjb29yZGluYXRlcyA9IHBvbHlnb24oby5hcmNzKTsgYnJlYWs7CgkgICAgICBjYXNlICJNdWx0aVBvbHlnb24iOiBjb29yZGluYXRlcyA9IG8uYXJjcy5tYXAocG9seWdvbik7IGJyZWFrOwoJICAgICAgZGVmYXVsdDogcmV0dXJuIG51bGw7CgkgICAgfQoJICAgIHJldHVybiB7dHlwZTogdHlwZSwgY29vcmRpbmF0ZXM6IGNvb3JkaW5hdGVzfTsKCSAgfQoKCSAgcmV0dXJuIGdlb21ldHJ5KG8pOwoJfQoKCWZ1bmN0aW9uICQoZWxlbWVudCwgdGFnTmFtZSkgewoJICAgIHJldHVybiBBcnJheS5mcm9tKGVsZW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUodGFnTmFtZSkpOwoJfQoJZnVuY3Rpb24gbm9ybWFsaXplSWQoaWQpIHsKCSAgICByZXR1cm4gaWRbMF0gPT09ICIjIiA/IGlkIDogYCMke2lkfWA7Cgl9CglmdW5jdGlvbiAkbnMoZWxlbWVudCwgdGFnTmFtZSwgbnMpIHsKCSAgICByZXR1cm4gQXJyYXkuZnJvbShlbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lTlMobnMsIHRhZ05hbWUpKTsKCX0KCS8qKgoJICogZ2V0IHRoZSBjb250ZW50IG9mIGEgdGV4dCBub2RlLCBpZiBhbnkKCSAqLwoJZnVuY3Rpb24gbm9kZVZhbChub2RlKSB7CgkgICAgbm9kZT8ubm9ybWFsaXplKCk7CgkgICAgcmV0dXJuIChub2RlICYmIG5vZGUudGV4dENvbnRlbnQpIHx8ICIiOwoJfQoJLyoqCgkgKiBHZXQgb25lIFkgY2hpbGQgb2YgWCwgaWYgYW55LCBvdGhlcndpc2UgbnVsbAoJICovCglmdW5jdGlvbiBnZXQxKG5vZGUsIHRhZ05hbWUsIGNhbGxiYWNrKSB7CgkgICAgY29uc3QgbiA9IG5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUodGFnTmFtZSk7CgkgICAgY29uc3QgcmVzdWx0ID0gbi5sZW5ndGggPyBuWzBdIDogbnVsbDsKCSAgICBpZiAocmVzdWx0ICYmIGNhbGxiYWNrKQoJICAgICAgICBjYWxsYmFjayhyZXN1bHQpOwoJICAgIHJldHVybiByZXN1bHQ7Cgl9CglmdW5jdGlvbiBnZXQobm9kZSwgdGFnTmFtZSwgY2FsbGJhY2spIHsKCSAgICBjb25zdCBwcm9wZXJ0aWVzID0ge307CgkgICAgaWYgKCFub2RlKQoJICAgICAgICByZXR1cm4gcHJvcGVydGllczsKCSAgICBjb25zdCBuID0gbm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSh0YWdOYW1lKTsKCSAgICBjb25zdCByZXN1bHQgPSBuLmxlbmd0aCA/IG5bMF0gOiBudWxsOwoJICAgIGlmIChyZXN1bHQgJiYgY2FsbGJhY2spIHsKCSAgICAgICAgcmV0dXJuIGNhbGxiYWNrKHJlc3VsdCwgcHJvcGVydGllcyk7CgkgICAgfQoJICAgIHJldHVybiBwcm9wZXJ0aWVzOwoJfQoJZnVuY3Rpb24gdmFsMShub2RlLCB0YWdOYW1lLCBjYWxsYmFjaykgewoJICAgIGNvbnN0IHZhbCA9IG5vZGVWYWwoZ2V0MShub2RlLCB0YWdOYW1lKSk7CgkgICAgaWYgKHZhbCAmJiBjYWxsYmFjaykKCSAgICAgICAgcmV0dXJuIGNhbGxiYWNrKHZhbCkgfHwge307CgkgICAgcmV0dXJuIHt9OwoJfQoJZnVuY3Rpb24gJG51bShub2RlLCB0YWdOYW1lLCBjYWxsYmFjaykgewoJICAgIGNvbnN0IHZhbCA9IHBhcnNlRmxvYXQobm9kZVZhbChnZXQxKG5vZGUsIHRhZ05hbWUpKSk7CgkgICAgaWYgKGlzTmFOKHZhbCkpCgkgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CgkgICAgaWYgKHZhbCAmJiBjYWxsYmFjaykKCSAgICAgICAgcmV0dXJuIGNhbGxiYWNrKHZhbCkgfHwge307CgkgICAgcmV0dXJuIHt9OwoJfQoJZnVuY3Rpb24gbnVtMShub2RlLCB0YWdOYW1lLCBjYWxsYmFjaykgewoJICAgIGNvbnN0IHZhbCA9IHBhcnNlRmxvYXQobm9kZVZhbChnZXQxKG5vZGUsIHRhZ05hbWUpKSk7CgkgICAgaWYgKGlzTmFOKHZhbCkpCgkgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CgkgICAgaWYgKHZhbCAmJiBjYWxsYmFjaykKCSAgICAgICAgY2FsbGJhY2sodmFsKTsKCSAgICByZXR1cm4gdmFsOwoJfQoJZnVuY3Rpb24gZ2V0TXVsdGkobm9kZSwgcHJvcGVydHlOYW1lcykgewoJICAgIGNvbnN0IHByb3BlcnRpZXMgPSB7fTsKCSAgICBmb3IgKGNvbnN0IHByb3BlcnR5IG9mIHByb3BlcnR5TmFtZXMpIHsKCSAgICAgICAgdmFsMShub2RlLCBwcm9wZXJ0eSwgKHZhbCkgPT4gewoJICAgICAgICAgICAgcHJvcGVydGllc1twcm9wZXJ0eV0gPSB2YWw7CgkgICAgICAgIH0pOwoJICAgIH0KCSAgICByZXR1cm4gcHJvcGVydGllczsKCX0KCWZ1bmN0aW9uIGlzRWxlbWVudChub2RlKSB7CgkgICAgcmV0dXJuIG5vZGU/Lm5vZGVUeXBlID09PSAxOwoJfQoKCWZ1bmN0aW9uIGdldExpbmVTdHlsZShub2RlKSB7CgkgICAgcmV0dXJuIGdldChub2RlLCAibGluZSIsIChsaW5lU3R5bGUpID0+IHsKCSAgICAgICAgY29uc3QgdmFsID0gT2JqZWN0LmFzc2lnbih7fSwgdmFsMShsaW5lU3R5bGUsICJjb2xvciIsIChjb2xvcikgPT4gewoJICAgICAgICAgICAgcmV0dXJuIHsgc3Ryb2tlOiBgIyR7Y29sb3J9YCB9OwoJICAgICAgICB9KSwgJG51bShsaW5lU3R5bGUsICJvcGFjaXR5IiwgKG9wYWNpdHkpID0+IHsKCSAgICAgICAgICAgIHJldHVybiB7ICJzdHJva2Utb3BhY2l0eSI6IG9wYWNpdHkgfTsKCSAgICAgICAgfSksICRudW0obGluZVN0eWxlLCAid2lkdGgiLCAod2lkdGgpID0+IHsKCSAgICAgICAgICAgIC8vIEdQWCB3aWR0aCBpcyBpbiBtbSwgY29udmVydCB0byBweCB3aXRoIDk2IHB4IHBlciBpbmNoCgkgICAgICAgICAgICByZXR1cm4geyAic3Ryb2tlLXdpZHRoIjogKHdpZHRoICogOTYpIC8gMjUuNCB9OwoJICAgICAgICB9KSk7CgkgICAgICAgIHJldHVybiB2YWw7CgkgICAgfSk7Cgl9CgoJZnVuY3Rpb24gZ2V0RXh0ZW5zaW9ucyhub2RlKSB7CgkgICAgbGV0IHZhbHVlcyA9IFtdOwoJICAgIGlmIChub2RlID09PSBudWxsKQoJICAgICAgICByZXR1cm4gdmFsdWVzOwoJICAgIGZvciAoY29uc3QgY2hpbGQgb2YgQXJyYXkuZnJvbShub2RlLmNoaWxkTm9kZXMpKSB7CgkgICAgICAgIGlmICghaXNFbGVtZW50KGNoaWxkKSkKCSAgICAgICAgICAgIGNvbnRpbnVlOwoJICAgICAgICBjb25zdCBuYW1lID0gYWJicmV2aWF0ZU5hbWUoY2hpbGQubm9kZU5hbWUpOwoJICAgICAgICBpZiAobmFtZSA9PT0gImdweHRweDpUcmFja1BvaW50RXh0ZW5zaW9uIikgewoJICAgICAgICAgICAgLy8gbG9vcCBhZ2FpbiBmb3IgbmVzdGVkIGdhcm1pbiBleHRlbnNpb25zIChlZy4gImdweHRweDpociIpCgkgICAgICAgICAgICB2YWx1ZXMgPSB2YWx1ZXMuY29uY2F0KGdldEV4dGVuc2lvbnMoY2hpbGQpKTsKCSAgICAgICAgfQoJICAgICAgICBlbHNlIHsKCSAgICAgICAgICAgIC8vIHB1c2ggY3VzdG9tIGV4dGVuc2lvbiAoZWcuICJwb3dlciIpCgkgICAgICAgICAgICBjb25zdCB2YWwgPSBub2RlVmFsKGNoaWxkKTsKCSAgICAgICAgICAgIHZhbHVlcy5wdXNoKFtuYW1lLCBwYXJzZU51bWVyaWModmFsKV0pOwoJICAgICAgICB9CgkgICAgfQoJICAgIHJldHVybiB2YWx1ZXM7Cgl9CglmdW5jdGlvbiBhYmJyZXZpYXRlTmFtZShuYW1lKSB7CgkgICAgcmV0dXJuIFsiaGVhcnQiLCAiZ3B4dHB4OmhyIiwgImhyIl0uaW5jbHVkZXMobmFtZSkgPyAiaGVhcnQiIDogbmFtZTsKCX0KCWZ1bmN0aW9uIHBhcnNlTnVtZXJpYyh2YWwpIHsKCSAgICBjb25zdCBudW0gPSBwYXJzZUZsb2F0KHZhbCk7CgkgICAgcmV0dXJuIGlzTmFOKG51bSkgPyB2YWwgOiBudW07Cgl9CgoJZnVuY3Rpb24gY29vcmRQYWlyJDEobm9kZSkgewoJICAgIGNvbnN0IGxsID0gWwoJICAgICAgICBwYXJzZUZsb2F0KG5vZGUuZ2V0QXR0cmlidXRlKCJsb24iKSB8fCAiIiksCgkgICAgICAgIHBhcnNlRmxvYXQobm9kZS5nZXRBdHRyaWJ1dGUoImxhdCIpIHx8ICIiKSwKCSAgICBdOwoJICAgIGlmIChpc05hTihsbFswXSkgfHwgaXNOYU4obGxbMV0pKSB7CgkgICAgICAgIHJldHVybiBudWxsOwoJICAgIH0KCSAgICBudW0xKG5vZGUsICJlbGUiLCAodmFsKSA9PiB7CgkgICAgICAgIGxsLnB1c2godmFsKTsKCSAgICB9KTsKCSAgICBjb25zdCB0aW1lID0gZ2V0MShub2RlLCAidGltZSIpOwoJICAgIHJldHVybiB7CgkgICAgICAgIGNvb3JkaW5hdGVzOiBsbCwKCSAgICAgICAgdGltZTogdGltZSA/IG5vZGVWYWwodGltZSkgOiBudWxsLAoJICAgICAgICBleHRlbmRlZFZhbHVlczogZ2V0RXh0ZW5zaW9ucyhnZXQxKG5vZGUsICJleHRlbnNpb25zIikpLAoJICAgIH07Cgl9CgoJZnVuY3Rpb24gZXh0cmFjdFByb3BlcnRpZXMobm9kZSkgewoJICAgIGNvbnN0IHByb3BlcnRpZXMgPSBnZXRNdWx0aShub2RlLCBbCgkgICAgICAgICJuYW1lIiwKCSAgICAgICAgImNtdCIsCgkgICAgICAgICJkZXNjIiwKCSAgICAgICAgInR5cGUiLAoJICAgICAgICAidGltZSIsCgkgICAgICAgICJrZXl3b3JkcyIsCgkgICAgXSk7CgkgICAgY29uc3QgZXh0ZW5zaW9ucyA9IEFycmF5LmZyb20obm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZU5TKCJodHRwOi8vd3d3Lmdhcm1pbi5jb20veG1sc2NoZW1hcy9HcHhFeHRlbnNpb25zL3YzIiwgIioiKSk7CgkgICAgZm9yIChjb25zdCBjaGlsZCBvZiBleHRlbnNpb25zKSB7CgkgICAgICAgIGlmIChjaGlsZC5wYXJlbnROb2RlPy5wYXJlbnROb2RlID09PSBub2RlKSB7CgkgICAgICAgICAgICBwcm9wZXJ0aWVzW2NoaWxkLnRhZ05hbWUucmVwbGFjZSgiOiIsICJfIildID0gbm9kZVZhbChjaGlsZCk7CgkgICAgICAgIH0KCSAgICB9CgkgICAgY29uc3QgbGlua3MgPSAkKG5vZGUsICJsaW5rIik7CgkgICAgaWYgKGxpbmtzLmxlbmd0aCkgewoJICAgICAgICBwcm9wZXJ0aWVzLmxpbmtzID0gbGlua3MubWFwKChsaW5rKSA9PiBPYmplY3QuYXNzaWduKHsgaHJlZjogbGluay5nZXRBdHRyaWJ1dGUoImhyZWYiKSB9LCBnZXRNdWx0aShsaW5rLCBbInRleHQiLCAidHlwZSJdKSkpOwoJICAgIH0KCSAgICByZXR1cm4gcHJvcGVydGllczsKCX0KCgkvKioKCSAqIEV4dHJhY3QgcG9pbnRzIGZyb20gYSB0cmtzZWcgb3IgcnRlIGVsZW1lbnQuCgkgKi8KCWZ1bmN0aW9uIGdldFBvaW50cyQxKG5vZGUsIHBvaW50bmFtZSkgewoJICAgIGNvbnN0IHB0cyA9ICQobm9kZSwgcG9pbnRuYW1lKTsKCSAgICBjb25zdCBsaW5lID0gW107CgkgICAgY29uc3QgdGltZXMgPSBbXTsKCSAgICBjb25zdCBleHRlbmRlZFZhbHVlcyA9IHt9OwoJICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcHRzLmxlbmd0aDsgaSsrKSB7CgkgICAgICAgIGNvbnN0IGMgPSBjb29yZFBhaXIkMShwdHNbaV0pOwoJICAgICAgICBpZiAoIWMpIHsKCSAgICAgICAgICAgIGNvbnRpbnVlOwoJICAgICAgICB9CgkgICAgICAgIGxpbmUucHVzaChjLmNvb3JkaW5hdGVzKTsKCSAgICAgICAgaWYgKGMudGltZSkKCSAgICAgICAgICAgIHRpbWVzLnB1c2goYy50aW1lKTsKCSAgICAgICAgZm9yIChjb25zdCBbbmFtZSwgdmFsXSBvZiBjLmV4dGVuZGVkVmFsdWVzKSB7CgkgICAgICAgICAgICBjb25zdCBwbHVyYWwgPSBuYW1lID09PSAiaGVhcnQiID8gbmFtZSA6IG5hbWUucmVwbGFjZSgiZ3B4dHB4OiIsICIiKSArICJzIjsKCSAgICAgICAgICAgIGlmICghZXh0ZW5kZWRWYWx1ZXNbcGx1cmFsXSkgewoJICAgICAgICAgICAgICAgIGV4dGVuZGVkVmFsdWVzW3BsdXJhbF0gPSBBcnJheShwdHMubGVuZ3RoKS5maWxsKG51bGwpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgZXh0ZW5kZWRWYWx1ZXNbcGx1cmFsXVtpXSA9IHZhbDsKCSAgICAgICAgfQoJICAgIH0KCSAgICBpZiAobGluZS5sZW5ndGggPCAyKQoJICAgICAgICByZXR1cm47IC8vIEludmFsaWQgbGluZSBpbiBHZW9KU09OCgkgICAgcmV0dXJuIHsKCSAgICAgICAgbGluZTogbGluZSwKCSAgICAgICAgdGltZXM6IHRpbWVzLAoJICAgICAgICBleHRlbmRlZFZhbHVlczogZXh0ZW5kZWRWYWx1ZXMsCgkgICAgfTsKCX0KCS8qKgoJICogRXh0cmFjdCBhIExpbmVTdHJpbmcgZ2VvbWV0cnkgZnJvbSBhIHJ0ZQoJICogZWxlbWVudC4KCSAqLwoJZnVuY3Rpb24gZ2V0Um91dGUobm9kZSkgewoJICAgIGNvbnN0IGxpbmUgPSBnZXRQb2ludHMkMShub2RlLCAicnRlcHQiKTsKCSAgICBpZiAoIWxpbmUpCgkgICAgICAgIHJldHVybjsKCSAgICByZXR1cm4gewoJICAgICAgICB0eXBlOiAiRmVhdHVyZSIsCgkgICAgICAgIHByb3BlcnRpZXM6IE9iamVjdC5hc3NpZ24oeyBfZ3B4VHlwZTogInJ0ZSIgfSwgZXh0cmFjdFByb3BlcnRpZXMobm9kZSksIGdldExpbmVTdHlsZShnZXQxKG5vZGUsICJleHRlbnNpb25zIikpKSwKCSAgICAgICAgZ2VvbWV0cnk6IHsKCSAgICAgICAgICAgIHR5cGU6ICJMaW5lU3RyaW5nIiwKCSAgICAgICAgICAgIGNvb3JkaW5hdGVzOiBsaW5lLmxpbmUsCgkgICAgICAgIH0sCgkgICAgfTsKCX0KCWZ1bmN0aW9uIGdldFRyYWNrKG5vZGUpIHsKCSAgICBjb25zdCBzZWdtZW50cyA9ICQobm9kZSwgInRya3NlZyIpOwoJICAgIGNvbnN0IHRyYWNrID0gW107CgkgICAgY29uc3QgdGltZXMgPSBbXTsKCSAgICBjb25zdCBleHRyYWN0ZWRMaW5lcyA9IFtdOwoJICAgIGZvciAoY29uc3Qgc2VnbWVudCBvZiBzZWdtZW50cykgewoJICAgICAgICBjb25zdCBsaW5lID0gZ2V0UG9pbnRzJDEoc2VnbWVudCwgInRya3B0Iik7CgkgICAgICAgIGlmIChsaW5lKSB7CgkgICAgICAgICAgICBleHRyYWN0ZWRMaW5lcy5wdXNoKGxpbmUpOwoJICAgICAgICAgICAgaWYgKGxpbmUudGltZXMgJiYgbGluZS50aW1lcy5sZW5ndGgpCgkgICAgICAgICAgICAgICAgdGltZXMucHVzaChsaW5lLnRpbWVzKTsKCSAgICAgICAgfQoJICAgIH0KCSAgICBpZiAoZXh0cmFjdGVkTGluZXMubGVuZ3RoID09PSAwKQoJICAgICAgICByZXR1cm4gbnVsbDsKCSAgICBjb25zdCBtdWx0aSA9IGV4dHJhY3RlZExpbmVzLmxlbmd0aCA+IDE7CgkgICAgY29uc3QgcHJvcGVydGllcyA9IE9iamVjdC5hc3NpZ24oeyBfZ3B4VHlwZTogInRyayIgfSwgZXh0cmFjdFByb3BlcnRpZXMobm9kZSksIGdldExpbmVTdHlsZShnZXQxKG5vZGUsICJleHRlbnNpb25zIikpLCB0aW1lcy5sZW5ndGgKCSAgICAgICAgPyB7CgkgICAgICAgICAgICBjb29yZGluYXRlUHJvcGVydGllczogewoJICAgICAgICAgICAgICAgIHRpbWVzOiBtdWx0aSA/IHRpbWVzIDogdGltZXNbMF0sCgkgICAgICAgICAgICB9LAoJICAgICAgICB9CgkgICAgICAgIDoge30pOwoJICAgIGZvciAoY29uc3QgbGluZSBvZiBleHRyYWN0ZWRMaW5lcykgewoJICAgICAgICB0cmFjay5wdXNoKGxpbmUubGluZSk7CgkgICAgICAgIGlmICghcHJvcGVydGllcy5jb29yZGluYXRlUHJvcGVydGllcykgewoJICAgICAgICAgICAgcHJvcGVydGllcy5jb29yZGluYXRlUHJvcGVydGllcyA9IHt9OwoJICAgICAgICB9CgkgICAgICAgIGNvbnN0IHByb3BzID0gcHJvcGVydGllcy5jb29yZGluYXRlUHJvcGVydGllczsKCSAgICAgICAgY29uc3QgZW50cmllcyA9IE9iamVjdC5lbnRyaWVzKGxpbmUuZXh0ZW5kZWRWYWx1ZXMpOwoJICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGVudHJpZXMubGVuZ3RoOyBpKyspIHsKCSAgICAgICAgICAgIGNvbnN0IFtuYW1lLCB2YWxdID0gZW50cmllc1tpXTsKCSAgICAgICAgICAgIGlmIChtdWx0aSkgewoJICAgICAgICAgICAgICAgIGlmICghcHJvcHNbbmFtZV0pIHsKCSAgICAgICAgICAgICAgICAgICAgcHJvcHNbbmFtZV0gPSBleHRyYWN0ZWRMaW5lcy5tYXAoKGxpbmUpID0+IG5ldyBBcnJheShsaW5lLmxpbmUubGVuZ3RoKS5maWxsKG51bGwpKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgcHJvcHNbbmFtZV1baV0gPSB2YWw7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBlbHNlIHsKCSAgICAgICAgICAgICAgICBwcm9wc1tuYW1lXSA9IHZhbDsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoJICAgIH0KCSAgICByZXR1cm4gewoJICAgICAgICB0eXBlOiAiRmVhdHVyZSIsCgkgICAgICAgIHByb3BlcnRpZXM6IHByb3BlcnRpZXMsCgkgICAgICAgIGdlb21ldHJ5OiBtdWx0aQoJICAgICAgICAgICAgPyB7CgkgICAgICAgICAgICAgICAgdHlwZTogIk11bHRpTGluZVN0cmluZyIsCgkgICAgICAgICAgICAgICAgY29vcmRpbmF0ZXM6IHRyYWNrLAoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgOiB7CgkgICAgICAgICAgICAgICAgdHlwZTogIkxpbmVTdHJpbmciLAoJICAgICAgICAgICAgICAgIGNvb3JkaW5hdGVzOiB0cmFja1swXSwKCSAgICAgICAgICAgIH0sCgkgICAgfTsKCX0KCS8qKgoJICogRXh0cmFjdCBhIHBvaW50LCBpZiBwb3NzaWJsZSwgZnJvbSBhIGdpdmVuIG5vZGUsCgkgKiB3aGljaCBpcyB1c3VhbGx5IGEgd3B0IG9yIHRya3B0CgkgKi8KCWZ1bmN0aW9uIGdldFBvaW50KG5vZGUpIHsKCSAgICBjb25zdCBwcm9wZXJ0aWVzID0gT2JqZWN0LmFzc2lnbihleHRyYWN0UHJvcGVydGllcyhub2RlKSwgZ2V0TXVsdGkobm9kZSwgWyJzeW0iXSkpOwoJICAgIGNvbnN0IHBhaXIgPSBjb29yZFBhaXIkMShub2RlKTsKCSAgICBpZiAoIXBhaXIpCgkgICAgICAgIHJldHVybiBudWxsOwoJICAgIHJldHVybiB7CgkgICAgICAgIHR5cGU6ICJGZWF0dXJlIiwKCSAgICAgICAgcHJvcGVydGllcywKCSAgICAgICAgZ2VvbWV0cnk6IHsKCSAgICAgICAgICAgIHR5cGU6ICJQb2ludCIsCgkgICAgICAgICAgICBjb29yZGluYXRlczogcGFpci5jb29yZGluYXRlcywKCSAgICAgICAgfSwKCSAgICB9OwoJfQoJLyoqCgkgKiBDb252ZXJ0IEdQWCB0byBHZW9KU09OIGluY3JlbWVudGFsbHksIHJldHVybmluZwoJICogYSBbR2VuZXJhdG9yXShodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9KYXZhU2NyaXB0L0d1aWRlL0l0ZXJhdG9yc19hbmRfR2VuZXJhdG9ycykKCSAqIHRoYXQgeWllbGRzIG91dHB1dCBmZWF0dXJlIGJ5IGZlYXR1cmUuCgkgKi8KCWZ1bmN0aW9uKiBncHhHZW4obm9kZSkgewoJICAgIGZvciAoY29uc3QgdHJhY2sgb2YgJChub2RlLCAidHJrIikpIHsKCSAgICAgICAgY29uc3QgZmVhdHVyZSA9IGdldFRyYWNrKHRyYWNrKTsKCSAgICAgICAgaWYgKGZlYXR1cmUpCgkgICAgICAgICAgICB5aWVsZCBmZWF0dXJlOwoJICAgIH0KCSAgICBmb3IgKGNvbnN0IHJvdXRlIG9mICQobm9kZSwgInJ0ZSIpKSB7CgkgICAgICAgIGNvbnN0IGZlYXR1cmUgPSBnZXRSb3V0ZShyb3V0ZSk7CgkgICAgICAgIGlmIChmZWF0dXJlKQoJICAgICAgICAgICAgeWllbGQgZmVhdHVyZTsKCSAgICB9CgkgICAgZm9yIChjb25zdCB3YXlwb2ludCBvZiAkKG5vZGUsICJ3cHQiKSkgewoJICAgICAgICBjb25zdCBwb2ludCA9IGdldFBvaW50KHdheXBvaW50KTsKCSAgICAgICAgaWYgKHBvaW50KQoJICAgICAgICAgICAgeWllbGQgcG9pbnQ7CgkgICAgfQoJfQoJLyoqCgkgKgoJICogQ29udmVydCBhIEdQWCBkb2N1bWVudCB0byBHZW9KU09OLiBUaGUgZmlyc3QgYXJndW1lbnQsIGBkb2NgLCBtdXN0IGJlIGEgR1BYCgkgKiBkb2N1bWVudCBhcyBhbiBYTUwgRE9NIC0gbm90IGFzIGEgc3RyaW5nLiBZb3UgY2FuIGdldCB0aGlzIHVzaW5nIGpRdWVyeSdzIGRlZmF1bHQKCSAqIGAuYWpheGAgZnVuY3Rpb24gb3IgdXNpbmcgYSBiYXJlIFhNTEh0dHBSZXF1ZXN0IHdpdGggdGhlIGAucmVzcG9uc2VgIHByb3BlcnR5CgkgKiBob2xkaW5nIGFuIFhNTCBET00uCgkgKgoJICogVGhlIG91dHB1dCBpcyBhIEphdmFTY3JpcHQgb2JqZWN0IG9mIEdlb0pTT04gZGF0YSwgc2FtZSBhcyBgLmttbGAgb3V0cHV0cywgd2l0aCB0aGUKCSAqIGFkZGl0aW9uIG9mIGEgYF9ncHhUeXBlYCBwcm9wZXJ0eSBvbiBlYWNoIGBMaW5lU3RyaW5nYCBmZWF0dXJlIHRoYXQgaW5kaWNhdGVzIHdoZXRoZXIKCSAqIHRoZSBmZWF0dXJlIHdhcyBlbmNvZGVkIGFzIGEgcm91dGUgKGBydGVgKSBvciB0cmFjayAoYHRya2ApIGluIHRoZSBHUFggZG9jdW1lbnQuCgkgKi8KCWZ1bmN0aW9uIGdweChub2RlKSB7CgkgICAgcmV0dXJuIHsKCSAgICAgICAgdHlwZTogIkZlYXR1cmVDb2xsZWN0aW9uIiwKCSAgICAgICAgZmVhdHVyZXM6IEFycmF5LmZyb20oZ3B4R2VuKG5vZGUpKSwKCSAgICB9OwoJfQoKCWNvbnN0IEVYVEVOU0lPTlNfTlMgPSAiaHR0cDovL3d3dy5nYXJtaW4uY29tL3htbHNjaGVtYXMvQWN0aXZpdHlFeHRlbnNpb24vdjIiOwoJY29uc3QgVFJBQ0tQT0lOVF9BVFRSSUJVVEVTID0gWwoJICAgIFsiaGVhcnRSYXRlIiwgImhlYXJ0UmF0ZXMiXSwKCSAgICBbIkNhZGVuY2UiLCAiY2FkZW5jZXMiXSwKCSAgICAvLyBFeHRlbmRlZCBUcmFja3BvaW50IGF0dHJpYnV0ZXMKCSAgICBbIlNwZWVkIiwgInNwZWVkcyJdLAoJICAgIFsiV2F0dHMiLCAid2F0dHMiXSwKCV07Cgljb25zdCBMQVBfQVRUUklCVVRFUyA9IFsKCSAgICBbIlRvdGFsVGltZVNlY29uZHMiLCAidG90YWxUaW1lU2Vjb25kcyJdLAoJICAgIFsiRGlzdGFuY2VNZXRlcnMiLCAiZGlzdGFuY2VNZXRlcnMiXSwKCSAgICBbIk1heGltdW1TcGVlZCIsICJtYXhTcGVlZCJdLAoJICAgIFsiQXZlcmFnZUhlYXJ0UmF0ZUJwbSIsICJhdmdIZWFydFJhdGUiXSwKCSAgICBbIk1heGltdW1IZWFydFJhdGVCcG0iLCAibWF4SGVhcnRSYXRlIl0sCgkgICAgLy8gRXh0ZW5kZWQgTGFwIGF0dHJpYnV0ZXMKCSAgICBbIkF2Z1NwZWVkIiwgImF2Z1NwZWVkIl0sCgkgICAgWyJBdmdXYXR0cyIsICJhdmdXYXR0cyJdLAoJICAgIFsiTWF4V2F0dHMiLCAibWF4V2F0dHMiXSwKCV07CglmdW5jdGlvbiBnZXRQcm9wZXJ0aWVzKG5vZGUsIGF0dHJpYnV0ZU5hbWVzKSB7CgkgICAgY29uc3QgcHJvcGVydGllcyA9IFtdOwoJICAgIGZvciAoY29uc3QgW3RhZywgYWxpYXNdIG9mIGF0dHJpYnV0ZU5hbWVzKSB7CgkgICAgICAgIGxldCBlbGVtID0gZ2V0MShub2RlLCB0YWcpOwoJICAgICAgICBpZiAoIWVsZW0pIHsKCSAgICAgICAgICAgIGNvbnN0IGVsZW1lbnRzID0gbm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZU5TKEVYVEVOU0lPTlNfTlMsIHRhZyk7CgkgICAgICAgICAgICBpZiAoZWxlbWVudHMubGVuZ3RoKSB7CgkgICAgICAgICAgICAgICAgZWxlbSA9IGVsZW1lbnRzWzBdOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgICAgIGNvbnN0IHZhbCA9IHBhcnNlRmxvYXQobm9kZVZhbChlbGVtKSk7CgkgICAgICAgIGlmICghaXNOYU4odmFsKSkgewoJICAgICAgICAgICAgcHJvcGVydGllcy5wdXNoKFthbGlhcywgdmFsXSk7CgkgICAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIHByb3BlcnRpZXM7Cgl9CglmdW5jdGlvbiBjb29yZFBhaXIobm9kZSkgewoJICAgIGNvbnN0IGxsID0gW251bTEobm9kZSwgIkxvbmdpdHVkZURlZ3JlZXMiKSwgbnVtMShub2RlLCAiTGF0aXR1ZGVEZWdyZWVzIildOwoJICAgIGlmIChsbFswXSA9PT0gdW5kZWZpbmVkIHx8CgkgICAgICAgIGlzTmFOKGxsWzBdKSB8fAoJICAgICAgICBsbFsxXSA9PT0gdW5kZWZpbmVkIHx8CgkgICAgICAgIGlzTmFOKGxsWzFdKSkgewoJICAgICAgICByZXR1cm4gbnVsbDsKCSAgICB9CgkgICAgY29uc3QgaGVhcnRSYXRlID0gZ2V0MShub2RlLCAiSGVhcnRSYXRlQnBtIik7CgkgICAgY29uc3QgdGltZSA9IG5vZGVWYWwoZ2V0MShub2RlLCAiVGltZSIpKTsKCSAgICBnZXQxKG5vZGUsICJBbHRpdHVkZU1ldGVycyIsIChhbHQpID0+IHsKCSAgICAgICAgY29uc3QgYSA9IHBhcnNlRmxvYXQobm9kZVZhbChhbHQpKTsKCSAgICAgICAgaWYgKCFpc05hTihhKSkgewoJICAgICAgICAgICAgbGwucHVzaChhKTsKCSAgICAgICAgfQoJICAgIH0pOwoJICAgIHJldHVybiB7CgkgICAgICAgIGNvb3JkaW5hdGVzOiBsbCwKCSAgICAgICAgdGltZTogdGltZSB8fCBudWxsLAoJICAgICAgICBoZWFydFJhdGU6IGhlYXJ0UmF0ZSA/IHBhcnNlRmxvYXQobm9kZVZhbChoZWFydFJhdGUpKSA6IG51bGwsCgkgICAgICAgIGV4dGVuc2lvbnM6IGdldFByb3BlcnRpZXMobm9kZSwgVFJBQ0tQT0lOVF9BVFRSSUJVVEVTKSwKCSAgICB9OwoJfQoJZnVuY3Rpb24gZ2V0UG9pbnRzKG5vZGUpIHsKCSAgICBjb25zdCBwdHMgPSAkKG5vZGUsICJUcmFja3BvaW50Iik7CgkgICAgY29uc3QgbGluZSA9IFtdOwoJICAgIGNvbnN0IHRpbWVzID0gW107CgkgICAgY29uc3QgaGVhcnRSYXRlcyA9IFtdOwoJICAgIGlmIChwdHMubGVuZ3RoIDwgMikKCSAgICAgICAgcmV0dXJuIG51bGw7IC8vIEludmFsaWQgbGluZSBpbiBHZW9KU09OCgkgICAgY29uc3QgZXh0ZW5kZWRQcm9wZXJ0aWVzID0ge307CgkgICAgY29uc3QgcmVzdWx0ID0geyBleHRlbmRlZFByb3BlcnRpZXMgfTsKCSAgICBmb3IgKGxldCBpID0gMDsgaSA8IHB0cy5sZW5ndGg7IGkrKykgewoJICAgICAgICBjb25zdCBjID0gY29vcmRQYWlyKHB0c1tpXSk7CgkgICAgICAgIGlmIChjID09PSBudWxsKQoJICAgICAgICAgICAgY29udGludWU7CgkgICAgICAgIGxpbmUucHVzaChjLmNvb3JkaW5hdGVzKTsKCSAgICAgICAgY29uc3QgeyB0aW1lLCBoZWFydFJhdGUsIGV4dGVuc2lvbnMgfSA9IGM7CgkgICAgICAgIGlmICh0aW1lKQoJICAgICAgICAgICAgdGltZXMucHVzaCh0aW1lKTsKCSAgICAgICAgaWYgKGhlYXJ0UmF0ZSkKCSAgICAgICAgICAgIGhlYXJ0UmF0ZXMucHVzaChoZWFydFJhdGUpOwoJICAgICAgICBmb3IgKGNvbnN0IFthbGlhcywgdmFsdWVdIG9mIGV4dGVuc2lvbnMpIHsKCSAgICAgICAgICAgIGlmICghZXh0ZW5kZWRQcm9wZXJ0aWVzW2FsaWFzXSkgewoJICAgICAgICAgICAgICAgIGV4dGVuZGVkUHJvcGVydGllc1thbGlhc10gPSBBcnJheShwdHMubGVuZ3RoKS5maWxsKG51bGwpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgZXh0ZW5kZWRQcm9wZXJ0aWVzW2FsaWFzXVtpXSA9IHZhbHVlOwoJICAgICAgICB9CgkgICAgfQoJICAgIGlmIChsaW5lLmxlbmd0aCA8IDIpCgkgICAgICAgIHJldHVybiBudWxsOwoJICAgIHJldHVybiBPYmplY3QuYXNzaWduKHJlc3VsdCwgewoJICAgICAgICBsaW5lOiBsaW5lLAoJICAgICAgICB0aW1lczogdGltZXMsCgkgICAgICAgIGhlYXJ0UmF0ZXM6IGhlYXJ0UmF0ZXMsCgkgICAgfSk7Cgl9CglmdW5jdGlvbiBnZXRMYXAobm9kZSkgewoJICAgIGNvbnN0IHNlZ21lbnRzID0gJChub2RlLCAiVHJhY2siKTsKCSAgICBjb25zdCB0cmFjayA9IFtdOwoJICAgIGNvbnN0IHRpbWVzID0gW107CgkgICAgY29uc3QgaGVhcnRSYXRlcyA9IFtdOwoJICAgIGNvbnN0IGFsbEV4dGVuZGVkUHJvcGVydGllcyA9IFtdOwoJICAgIGxldCBsaW5lOwoJICAgIGNvbnN0IHByb3BlcnRpZXMgPSBPYmplY3QuYXNzaWduKE9iamVjdC5mcm9tRW50cmllcyhnZXRQcm9wZXJ0aWVzKG5vZGUsIExBUF9BVFRSSUJVVEVTKSksIGdldChub2RlLCAiTmFtZSIsIChuYW1lRWxlbWVudCkgPT4gewoJICAgICAgICByZXR1cm4geyBuYW1lOiBub2RlVmFsKG5hbWVFbGVtZW50KSB9OwoJICAgIH0pKTsKCSAgICBmb3IgKGNvbnN0IHNlZ21lbnQgb2Ygc2VnbWVudHMpIHsKCSAgICAgICAgbGluZSA9IGdldFBvaW50cyhzZWdtZW50KTsKCSAgICAgICAgaWYgKGxpbmUpIHsKCSAgICAgICAgICAgIHRyYWNrLnB1c2gobGluZS5saW5lKTsKCSAgICAgICAgICAgIGlmIChsaW5lLnRpbWVzLmxlbmd0aCkKCSAgICAgICAgICAgICAgICB0aW1lcy5wdXNoKGxpbmUudGltZXMpOwoJICAgICAgICAgICAgaWYgKGxpbmUuaGVhcnRSYXRlcy5sZW5ndGgpCgkgICAgICAgICAgICAgICAgaGVhcnRSYXRlcy5wdXNoKGxpbmUuaGVhcnRSYXRlcyk7CgkgICAgICAgICAgICBhbGxFeHRlbmRlZFByb3BlcnRpZXMucHVzaChsaW5lLmV4dGVuZGVkUHJvcGVydGllcyk7CgkgICAgICAgIH0KCSAgICB9CgkgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhbGxFeHRlbmRlZFByb3BlcnRpZXMubGVuZ3RoOyBpKyspIHsKCSAgICAgICAgY29uc3QgZXh0ZW5kZWRQcm9wZXJ0aWVzID0gYWxsRXh0ZW5kZWRQcm9wZXJ0aWVzW2ldOwoJICAgICAgICBmb3IgKGNvbnN0IHByb3BlcnR5IGluIGV4dGVuZGVkUHJvcGVydGllcykgewoJICAgICAgICAgICAgaWYgKHNlZ21lbnRzLmxlbmd0aCA9PT0gMSkgewoJICAgICAgICAgICAgICAgIGlmIChsaW5lKSB7CgkgICAgICAgICAgICAgICAgICAgIHByb3BlcnRpZXNbcHJvcGVydHldID0gbGluZS5leHRlbmRlZFByb3BlcnRpZXNbcHJvcGVydHldOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGVsc2UgewoJICAgICAgICAgICAgICAgIGlmICghcHJvcGVydGllc1twcm9wZXJ0eV0pIHsKCSAgICAgICAgICAgICAgICAgICAgcHJvcGVydGllc1twcm9wZXJ0eV0gPSB0cmFjay5tYXAoKHRyYWNrKSA9PiBBcnJheSh0cmFjay5sZW5ndGgpLmZpbGwobnVsbCkpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzW3Byb3BlcnR5XVtpXSA9IGV4dGVuZGVkUHJvcGVydGllc1twcm9wZXJ0eV07CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICB9CgkgICAgaWYgKHRyYWNrLmxlbmd0aCA9PT0gMCkKCSAgICAgICAgcmV0dXJuIG51bGw7CgkgICAgaWYgKHRpbWVzLmxlbmd0aCB8fCBoZWFydFJhdGVzLmxlbmd0aCkgewoJICAgICAgICBwcm9wZXJ0aWVzLmNvb3JkaW5hdGVQcm9wZXJ0aWVzID0gT2JqZWN0LmFzc2lnbih0aW1lcy5sZW5ndGgKCSAgICAgICAgICAgID8gewoJICAgICAgICAgICAgICAgIHRpbWVzOiB0cmFjay5sZW5ndGggPT09IDEgPyB0aW1lc1swXSA6IHRpbWVzLAoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgOiB7fSwgaGVhcnRSYXRlcy5sZW5ndGgKCSAgICAgICAgICAgID8gewoJICAgICAgICAgICAgICAgIGhlYXJ0OiB0cmFjay5sZW5ndGggPT09IDEgPyBoZWFydFJhdGVzWzBdIDogaGVhcnRSYXRlcywKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIDoge30pOwoJICAgIH0KCSAgICByZXR1cm4gewoJICAgICAgICB0eXBlOiAiRmVhdHVyZSIsCgkgICAgICAgIHByb3BlcnRpZXM6IHByb3BlcnRpZXMsCgkgICAgICAgIGdlb21ldHJ5OiB0cmFjay5sZW5ndGggPT09IDEKCSAgICAgICAgICAgID8gewoJICAgICAgICAgICAgICAgIHR5cGU6ICJMaW5lU3RyaW5nIiwKCSAgICAgICAgICAgICAgICBjb29yZGluYXRlczogdHJhY2tbMF0sCgkgICAgICAgICAgICB9CgkgICAgICAgICAgICA6IHsKCSAgICAgICAgICAgICAgICB0eXBlOiAiTXVsdGlMaW5lU3RyaW5nIiwKCSAgICAgICAgICAgICAgICBjb29yZGluYXRlczogdHJhY2ssCgkgICAgICAgICAgICB9LAoJICAgIH07Cgl9CgkvKioKCSAqIEluY3JlbWVudGFsbHkgY29udmVydCBhIFRDWCBkb2N1bWVudCB0byBHZW9KU09OLiBUaGUKCSAqIGZpcnN0IGFyZ3VtZW50LCBgZG9jYCwgbXVzdCBiZSBhIFRDWAoJICogZG9jdW1lbnQgYXMgYW4gWE1MIERPTSAtIG5vdCBhcyBhIHN0cmluZy4KCSAqLwoJZnVuY3Rpb24qIHRjeEdlbihub2RlKSB7CgkgICAgZm9yIChjb25zdCBsYXAgb2YgJChub2RlLCAiTGFwIikpIHsKCSAgICAgICAgY29uc3QgZmVhdHVyZSA9IGdldExhcChsYXApOwoJICAgICAgICBpZiAoZmVhdHVyZSkKCSAgICAgICAgICAgIHlpZWxkIGZlYXR1cmU7CgkgICAgfQoJICAgIGZvciAoY29uc3QgY291cnNlIG9mICQobm9kZSwgIkNvdXJzZXMiKSkgewoJICAgICAgICBjb25zdCBmZWF0dXJlID0gZ2V0TGFwKGNvdXJzZSk7CgkgICAgICAgIGlmIChmZWF0dXJlKQoJICAgICAgICAgICAgeWllbGQgZmVhdHVyZTsKCSAgICB9Cgl9CgkvKioKCSAqIENvbnZlcnQgYSBUQ1ggZG9jdW1lbnQgdG8gR2VvSlNPTi4gVGhlIGZpcnN0IGFyZ3VtZW50LCBgZG9jYCwgbXVzdCBiZSBhIFRDWAoJICogZG9jdW1lbnQgYXMgYW4gWE1MIERPTSAtIG5vdCBhcyBhIHN0cmluZy4KCSAqLwoJZnVuY3Rpb24gdGN4KG5vZGUpIHsKCSAgICByZXR1cm4gewoJICAgICAgICB0eXBlOiAiRmVhdHVyZUNvbGxlY3Rpb24iLAoJICAgICAgICBmZWF0dXJlczogQXJyYXkuZnJvbSh0Y3hHZW4obm9kZSkpLAoJICAgIH07Cgl9CgoJZnVuY3Rpb24gZml4Q29sb3IodiwgcHJlZml4KSB7CgkgICAgY29uc3QgcHJvcGVydGllcyA9IHt9OwoJICAgIGNvbnN0IGNvbG9yUHJvcCA9IHByZWZpeCA9PSAic3Ryb2tlIiB8fCBwcmVmaXggPT09ICJmaWxsIiA/IHByZWZpeCA6IHByZWZpeCArICItY29sb3IiOwoJICAgIGlmICh2WzBdID09PSAiIyIpIHsKCSAgICAgICAgdiA9IHYuc3Vic3RyaW5nKDEpOwoJICAgIH0KCSAgICBpZiAodi5sZW5ndGggPT09IDYgfHwgdi5sZW5ndGggPT09IDMpIHsKCSAgICAgICAgcHJvcGVydGllc1tjb2xvclByb3BdID0gIiMiICsgdjsKCSAgICB9CgkgICAgZWxzZSBpZiAodi5sZW5ndGggPT09IDgpIHsKCSAgICAgICAgcHJvcGVydGllc1twcmVmaXggKyAiLW9wYWNpdHkiXSA9IHBhcnNlSW50KHYuc3Vic3RyaW5nKDAsIDIpLCAxNikgLyAyNTU7CgkgICAgICAgIHByb3BlcnRpZXNbY29sb3JQcm9wXSA9CgkgICAgICAgICAgICAiIyIgKyB2LnN1YnN0cmluZyg2LCA4KSArIHYuc3Vic3RyaW5nKDQsIDYpICsgdi5zdWJzdHJpbmcoMiwgNCk7CgkgICAgfQoJICAgIHJldHVybiBwcm9wZXJ0aWVzOwoJfQoKCWZ1bmN0aW9uIG51bWVyaWNQcm9wZXJ0eShub2RlLCBzb3VyY2UsIHRhcmdldCkgewoJICAgIGNvbnN0IHByb3BlcnRpZXMgPSB7fTsKCSAgICBudW0xKG5vZGUsIHNvdXJjZSwgKHZhbCkgPT4gewoJICAgICAgICBwcm9wZXJ0aWVzW3RhcmdldF0gPSB2YWw7CgkgICAgfSk7CgkgICAgcmV0dXJuIHByb3BlcnRpZXM7Cgl9CglmdW5jdGlvbiBnZXRDb2xvcihub2RlLCBvdXRwdXQpIHsKCSAgICByZXR1cm4gZ2V0KG5vZGUsICJjb2xvciIsIChlbGVtKSA9PiBmaXhDb2xvcihub2RlVmFsKGVsZW0pLCBvdXRwdXQpKTsKCX0KCWZ1bmN0aW9uIGV4dHJhY3RJY29uSHJlZihub2RlKSB7CgkgICAgcmV0dXJuIGdldChub2RlLCAiSWNvbiIsIChpY29uLCBwcm9wZXJ0aWVzKSA9PiB7CgkgICAgICAgIHZhbDEoaWNvbiwgImhyZWYiLCAoaHJlZikgPT4gewoJICAgICAgICAgICAgcHJvcGVydGllcy5pY29uID0gaHJlZjsKCSAgICAgICAgfSk7CgkgICAgICAgIHJldHVybiBwcm9wZXJ0aWVzOwoJICAgIH0pOwoJfQoJZnVuY3Rpb24gZXh0cmFjdEljb24obm9kZSkgewoJICAgIHJldHVybiBnZXQobm9kZSwgIkljb25TdHlsZSIsIChpY29uU3R5bGUpID0+IHsKCSAgICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oZ2V0Q29sb3IoaWNvblN0eWxlLCAiaWNvbiIpLCBudW1lcmljUHJvcGVydHkoaWNvblN0eWxlLCAic2NhbGUiLCAiaWNvbi1zY2FsZSIpLCBudW1lcmljUHJvcGVydHkoaWNvblN0eWxlLCAiaGVhZGluZyIsICJpY29uLWhlYWRpbmciKSwgZ2V0KGljb25TdHlsZSwgImhvdFNwb3QiLCAoaG90c3BvdCkgPT4gewoJICAgICAgICAgICAgY29uc3QgbGVmdCA9IHBhcnNlRmxvYXQoaG90c3BvdC5nZXRBdHRyaWJ1dGUoIngiKSB8fCAiIik7CgkgICAgICAgICAgICBjb25zdCB0b3AgPSBwYXJzZUZsb2F0KGhvdHNwb3QuZ2V0QXR0cmlidXRlKCJ5IikgfHwgIiIpOwoJICAgICAgICAgICAgY29uc3QgeHVuaXRzID0gaG90c3BvdC5nZXRBdHRyaWJ1dGUoInh1bml0cyIpIHx8ICIiOwoJICAgICAgICAgICAgY29uc3QgeXVuaXRzID0gaG90c3BvdC5nZXRBdHRyaWJ1dGUoInl1bml0cyIpIHx8ICIiOwoJICAgICAgICAgICAgaWYgKCFpc05hTihsZWZ0KSAmJiAhaXNOYU4odG9wKSkKCSAgICAgICAgICAgICAgICByZXR1cm4gewoJICAgICAgICAgICAgICAgICAgICAiaWNvbi1vZmZzZXQiOiBbbGVmdCwgdG9wXSwKCSAgICAgICAgICAgICAgICAgICAgImljb24tb2Zmc2V0LXVuaXRzIjogW3h1bml0cywgeXVuaXRzXSwKCSAgICAgICAgICAgICAgICB9OwoJICAgICAgICAgICAgcmV0dXJuIHt9OwoJICAgICAgICB9KSwgZXh0cmFjdEljb25IcmVmKGljb25TdHlsZSkpOwoJICAgIH0pOwoJfQoJZnVuY3Rpb24gZXh0cmFjdExhYmVsKG5vZGUpIHsKCSAgICByZXR1cm4gZ2V0KG5vZGUsICJMYWJlbFN0eWxlIiwgKGxhYmVsU3R5bGUpID0+IHsKCSAgICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oZ2V0Q29sb3IobGFiZWxTdHlsZSwgImxhYmVsIiksIG51bWVyaWNQcm9wZXJ0eShsYWJlbFN0eWxlLCAic2NhbGUiLCAibGFiZWwtc2NhbGUiKSk7CgkgICAgfSk7Cgl9CglmdW5jdGlvbiBleHRyYWN0TGluZShub2RlKSB7CgkgICAgcmV0dXJuIGdldChub2RlLCAiTGluZVN0eWxlIiwgKGxpbmVTdHlsZSkgPT4gewoJICAgICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihnZXRDb2xvcihsaW5lU3R5bGUsICJzdHJva2UiKSwgbnVtZXJpY1Byb3BlcnR5KGxpbmVTdHlsZSwgIndpZHRoIiwgInN0cm9rZS13aWR0aCIpKTsKCSAgICB9KTsKCX0KCWZ1bmN0aW9uIGV4dHJhY3RQb2x5KG5vZGUpIHsKCSAgICByZXR1cm4gZ2V0KG5vZGUsICJQb2x5U3R5bGUiLCAocG9seVN0eWxlLCBwcm9wZXJ0aWVzKSA9PiB7CgkgICAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKHByb3BlcnRpZXMsIGdldChwb2x5U3R5bGUsICJjb2xvciIsIChlbGVtKSA9PiBmaXhDb2xvcihub2RlVmFsKGVsZW0pLCAiZmlsbCIpKSwgdmFsMShwb2x5U3R5bGUsICJmaWxsIiwgKGZpbGwpID0+IHsKCSAgICAgICAgICAgIGlmIChmaWxsID09PSAiMCIpCgkgICAgICAgICAgICAgICAgcmV0dXJuIHsgImZpbGwtb3BhY2l0eSI6IDAgfTsKCSAgICAgICAgfSksIHZhbDEocG9seVN0eWxlLCAib3V0bGluZSIsIChvdXRsaW5lKSA9PiB7CgkgICAgICAgICAgICBpZiAob3V0bGluZSA9PT0gIjAiKQoJICAgICAgICAgICAgICAgIHJldHVybiB7ICJzdHJva2Utb3BhY2l0eSI6IDAgfTsKCSAgICAgICAgfSkpOwoJICAgIH0pOwoJfQoJZnVuY3Rpb24gZXh0cmFjdFN0eWxlKG5vZGUpIHsKCSAgICByZXR1cm4gT2JqZWN0LmFzc2lnbih7fSwgZXh0cmFjdFBvbHkobm9kZSksIGV4dHJhY3RMaW5lKG5vZGUpLCBleHRyYWN0TGFiZWwobm9kZSksIGV4dHJhY3RJY29uKG5vZGUpKTsKCX0KCgljb25zdCB0b051bWJlciA9ICh4KSA9PiBOdW1iZXIoeCk7Cgljb25zdCB0eXBlQ29udmVydGVycyA9IHsKCSAgICBzdHJpbmc6ICh4KSA9PiB4LAoJICAgIGludDogdG9OdW1iZXIsCgkgICAgdWludDogdG9OdW1iZXIsCgkgICAgc2hvcnQ6IHRvTnVtYmVyLAoJICAgIHVzaG9ydDogdG9OdW1iZXIsCgkgICAgZmxvYXQ6IHRvTnVtYmVyLAoJICAgIGRvdWJsZTogdG9OdW1iZXIsCgkgICAgYm9vbDogKHgpID0+IEJvb2xlYW4oeCksCgl9OwoJZnVuY3Rpb24gZXh0cmFjdEV4dGVuZGVkRGF0YShub2RlLCBzY2hlbWEpIHsKCSAgICByZXR1cm4gZ2V0KG5vZGUsICJFeHRlbmRlZERhdGEiLCAoZXh0ZW5kZWREYXRhLCBwcm9wZXJ0aWVzKSA9PiB7CgkgICAgICAgIGZvciAoY29uc3QgZGF0YSBvZiAkKGV4dGVuZGVkRGF0YSwgIkRhdGEiKSkgewoJICAgICAgICAgICAgcHJvcGVydGllc1tkYXRhLmdldEF0dHJpYnV0ZSgibmFtZSIpIHx8ICIiXSA9IG5vZGVWYWwoZ2V0MShkYXRhLCAidmFsdWUiKSk7CgkgICAgICAgIH0KCSAgICAgICAgZm9yIChjb25zdCBzaW1wbGVEYXRhIG9mICQoZXh0ZW5kZWREYXRhLCAiU2ltcGxlRGF0YSIpKSB7CgkgICAgICAgICAgICBjb25zdCBuYW1lID0gc2ltcGxlRGF0YS5nZXRBdHRyaWJ1dGUoIm5hbWUiKSB8fCAiIjsKCSAgICAgICAgICAgIGNvbnN0IHR5cGVDb252ZXJ0ZXIgPSBzY2hlbWFbbmFtZV0gfHwgdHlwZUNvbnZlcnRlcnMuc3RyaW5nOwoJICAgICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IHR5cGVDb252ZXJ0ZXIobm9kZVZhbChzaW1wbGVEYXRhKSk7CgkgICAgICAgIH0KCSAgICAgICAgcmV0dXJuIHByb3BlcnRpZXM7CgkgICAgfSk7Cgl9CglmdW5jdGlvbiBnZXRNYXliZUhUTUxEZXNjcmlwdGlvbihub2RlKSB7CgkgICAgY29uc3QgZGVzY3JpcHRpb25Ob2RlID0gZ2V0MShub2RlLCAiZGVzY3JpcHRpb24iKTsKCSAgICBmb3IgKGNvbnN0IGMgb2YgQXJyYXkuZnJvbShkZXNjcmlwdGlvbk5vZGU/LmNoaWxkTm9kZXMgfHwgW10pKSB7CgkgICAgICAgIGlmIChjLm5vZGVUeXBlID09PSA0KSB7CgkgICAgICAgICAgICByZXR1cm4gewoJICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiB7CgkgICAgICAgICAgICAgICAgICAgICJAdHlwZSI6ICJodG1sIiwKCSAgICAgICAgICAgICAgICAgICAgdmFsdWU6IG5vZGVWYWwoYyksCgkgICAgICAgICAgICAgICAgfSwKCSAgICAgICAgICAgIH07CgkgICAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIHt9OwoJfQoJZnVuY3Rpb24gZXh0cmFjdFRpbWVTcGFuKG5vZGUpIHsKCSAgICByZXR1cm4gZ2V0KG5vZGUsICJUaW1lU3BhbiIsICh0aW1lU3BhbikgPT4gewoJICAgICAgICByZXR1cm4gewoJICAgICAgICAgICAgdGltZXNwYW46IHsKCSAgICAgICAgICAgICAgICBiZWdpbjogbm9kZVZhbChnZXQxKHRpbWVTcGFuLCAiYmVnaW4iKSksCgkgICAgICAgICAgICAgICAgZW5kOiBub2RlVmFsKGdldDEodGltZVNwYW4sICJlbmQiKSksCgkgICAgICAgICAgICB9LAoJICAgICAgICB9OwoJICAgIH0pOwoJfQoJZnVuY3Rpb24gZXh0cmFjdFRpbWVTdGFtcChub2RlKSB7CgkgICAgcmV0dXJuIGdldChub2RlLCAiVGltZVN0YW1wIiwgKHRpbWVTdGFtcCkgPT4gewoJICAgICAgICByZXR1cm4geyB0aW1lc3RhbXA6IG5vZGVWYWwoZ2V0MSh0aW1lU3RhbXAsICJ3aGVuIikpIH07CgkgICAgfSk7Cgl9CglmdW5jdGlvbiBleHRyYWN0Q2FzY2FkZWRTdHlsZShub2RlLCBzdHlsZU1hcCkgewoJICAgIHJldHVybiB2YWwxKG5vZGUsICJzdHlsZVVybCIsIChzdHlsZVVybCkgPT4gewoJICAgICAgICBzdHlsZVVybCA9IG5vcm1hbGl6ZUlkKHN0eWxlVXJsKTsKCSAgICAgICAgaWYgKHN0eWxlTWFwW3N0eWxlVXJsXSkgewoJICAgICAgICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oeyBzdHlsZVVybCB9LCBzdHlsZU1hcFtzdHlsZVVybF0pOwoJICAgICAgICB9CgkgICAgICAgIC8vIEZvciBiYWNrd2FyZC1jb21wYXRpYmlsaXR5LiBTaG91bGQgd2Ugc3RpbGwgaW5jbHVkZQoJICAgICAgICAvLyBzdHlsZVVybCBldmVuIGlmIGl0J3Mgbm90IHJlc29sdmVkPwoJICAgICAgICByZXR1cm4geyBzdHlsZVVybCB9OwoJICAgIH0pOwoJfQoKCWNvbnN0IHJlbW92ZVNwYWNlID0gL1xzKi9nOwoJY29uc3QgdHJpbVNwYWNlID0gL15ccyp8XHMqJC9nOwoJY29uc3Qgc3BsaXRTcGFjZSA9IC9ccysvOwoJLyoqCgkgKiBHZXQgb25lIGNvb3JkaW5hdGUgZnJvbSBhIGNvb3JkaW5hdGUgYXJyYXksIGlmIGFueQoJICovCglmdW5jdGlvbiBjb29yZDEodmFsdWUpIHsKCSAgICByZXR1cm4gdmFsdWUKCSAgICAgICAgLnJlcGxhY2UocmVtb3ZlU3BhY2UsICIiKQoJICAgICAgICAuc3BsaXQoIiwiKQoJICAgICAgICAubWFwKHBhcnNlRmxvYXQpCgkgICAgICAgIC5maWx0ZXIoKG51bSkgPT4gIWlzTmFOKG51bSkpCgkgICAgICAgIC5zbGljZSgwLCAzKTsKCX0KCS8qKgoJICogR2V0IGFsbCBjb29yZGluYXRlcyBmcm9tIGEgY29vcmRpbmF0ZSBhcnJheSBhcyBbW10sW11dCgkgKi8KCWZ1bmN0aW9uIGNvb3JkKHZhbHVlKSB7CgkgICAgcmV0dXJuIHZhbHVlCgkgICAgICAgIC5yZXBsYWNlKHRyaW1TcGFjZSwgIiIpCgkgICAgICAgIC5zcGxpdChzcGxpdFNwYWNlKQoJICAgICAgICAubWFwKGNvb3JkMSkKCSAgICAgICAgLmZpbHRlcigoY29vcmQpID0+IHsKCSAgICAgICAgcmV0dXJuIGNvb3JkLmxlbmd0aCA+PSAyOwoJICAgIH0pOwoJfQoJZnVuY3Rpb24gZ3hDb29yZHMobm9kZSkgewoJICAgIGxldCBlbGVtcyA9ICQobm9kZSwgImNvb3JkIik7CgkgICAgaWYgKGVsZW1zLmxlbmd0aCA9PT0gMCkgewoJICAgICAgICBlbGVtcyA9ICRucyhub2RlLCAiY29vcmQiLCAiKiIpOwoJICAgIH0KCSAgICBjb25zdCBjb29yZGluYXRlcyA9IGVsZW1zLm1hcCgoZWxlbSkgPT4gewoJICAgICAgICByZXR1cm4gbm9kZVZhbChlbGVtKS5zcGxpdCgiICIpLm1hcChwYXJzZUZsb2F0KTsKCSAgICB9KTsKCSAgICBpZiAoY29vcmRpbmF0ZXMubGVuZ3RoID09PSAwKSB7CgkgICAgICAgIHJldHVybiBudWxsOwoJICAgIH0KCSAgICByZXR1cm4gewoJICAgICAgICBnZW9tZXRyeTogY29vcmRpbmF0ZXMubGVuZ3RoID4gMgoJICAgICAgICAgICAgPyB7CgkgICAgICAgICAgICAgICAgdHlwZTogIkxpbmVTdHJpbmciLAoJICAgICAgICAgICAgICAgIGNvb3JkaW5hdGVzLAoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgOiB7CgkgICAgICAgICAgICAgICAgdHlwZTogIlBvaW50IiwKCSAgICAgICAgICAgICAgICBjb29yZGluYXRlczogY29vcmRpbmF0ZXNbMF0sCgkgICAgICAgICAgICB9LAoJICAgICAgICB0aW1lczogJChub2RlLCAid2hlbiIpLm1hcCgoZWxlbSkgPT4gbm9kZVZhbChlbGVtKSksCgkgICAgfTsKCX0KCWZ1bmN0aW9uIGZpeFJpbmcocmluZykgewoJICAgIGlmIChyaW5nLmxlbmd0aCA9PT0gMCkKCSAgICAgICAgcmV0dXJuIHJpbmc7CgkgICAgY29uc3QgZmlyc3QgPSByaW5nWzBdOwoJICAgIGNvbnN0IGxhc3QgPSByaW5nW3JpbmcubGVuZ3RoIC0gMV07CgkgICAgbGV0IGVxdWFsID0gdHJ1ZTsKCSAgICBmb3IgKGxldCBpID0gMDsgaSA8IE1hdGgubWF4KGZpcnN0Lmxlbmd0aCwgbGFzdC5sZW5ndGgpOyBpKyspIHsKCSAgICAgICAgaWYgKGZpcnN0W2ldICE9PSBsYXN0W2ldKSB7CgkgICAgICAgICAgICBlcXVhbCA9IGZhbHNlOwoJICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgIH0KCSAgICB9CgkgICAgaWYgKCFlcXVhbCkgewoJICAgICAgICByZXR1cm4gcmluZy5jb25jYXQoW3JpbmdbMF1dKTsKCSAgICB9CgkgICAgcmV0dXJuIHJpbmc7Cgl9CglmdW5jdGlvbiBnZXRDb29yZGluYXRlcyhub2RlKSB7CgkgICAgcmV0dXJuIG5vZGVWYWwoZ2V0MShub2RlLCAiY29vcmRpbmF0ZXMiKSk7Cgl9CglmdW5jdGlvbiBnZXRHZW9tZXRyeShub2RlKSB7CgkgICAgbGV0IGdlb21ldHJpZXMgPSBbXTsKCSAgICBsZXQgY29vcmRUaW1lcyA9IFtdOwoJICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZS5jaGlsZE5vZGVzLmxlbmd0aDsgaSsrKSB7CgkgICAgICAgIGNvbnN0IGNoaWxkID0gbm9kZS5jaGlsZE5vZGVzLml0ZW0oaSk7CgkgICAgICAgIGlmIChpc0VsZW1lbnQoY2hpbGQpKSB7CgkgICAgICAgICAgICBzd2l0Y2ggKGNoaWxkLnRhZ05hbWUpIHsKCSAgICAgICAgICAgICAgICBjYXNlICJNdWx0aUdlb21ldHJ5IjoKCSAgICAgICAgICAgICAgICBjYXNlICJNdWx0aVRyYWNrIjoKCSAgICAgICAgICAgICAgICBjYXNlICJneDpNdWx0aVRyYWNrIjogewoJICAgICAgICAgICAgICAgICAgICBjb25zdCBjaGlsZEdlb21ldHJpZXMgPSBnZXRHZW9tZXRyeShjaGlsZCk7CgkgICAgICAgICAgICAgICAgICAgIGdlb21ldHJpZXMgPSBnZW9tZXRyaWVzLmNvbmNhdChjaGlsZEdlb21ldHJpZXMuZ2VvbWV0cmllcyk7CgkgICAgICAgICAgICAgICAgICAgIGNvb3JkVGltZXMgPSBjb29yZFRpbWVzLmNvbmNhdChjaGlsZEdlb21ldHJpZXMuY29vcmRUaW1lcyk7CgkgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICBjYXNlICJQb2ludCI6IHsKCSAgICAgICAgICAgICAgICAgICAgY29uc3QgY29vcmRpbmF0ZXMgPSBjb29yZDEoZ2V0Q29vcmRpbmF0ZXMoY2hpbGQpKTsKCSAgICAgICAgICAgICAgICAgICAgaWYgKGNvb3JkaW5hdGVzLmxlbmd0aCA+PSAyKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBnZW9tZXRyaWVzLnB1c2goewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJQb2ludCIsCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29vcmRpbmF0ZXMsCgkgICAgICAgICAgICAgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgY2FzZSAiTGluZWFyUmluZyI6CgkgICAgICAgICAgICAgICAgY2FzZSAiTGluZVN0cmluZyI6IHsKCSAgICAgICAgICAgICAgICAgICAgY29uc3QgY29vcmRpbmF0ZXMgPSBjb29yZChnZXRDb29yZGluYXRlcyhjaGlsZCkpOwoJICAgICAgICAgICAgICAgICAgICBpZiAoY29vcmRpbmF0ZXMubGVuZ3RoID49IDIpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGdlb21ldHJpZXMucHVzaCh7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogIkxpbmVTdHJpbmciLAoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvb3JkaW5hdGVzLAoJICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIGNhc2UgIlBvbHlnb24iOiB7CgkgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvb3JkcyA9IFtdOwoJICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGxpbmVhclJpbmcgb2YgJChjaGlsZCwgIkxpbmVhclJpbmciKSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmluZyA9IGZpeFJpbmcoY29vcmQoZ2V0Q29vcmRpbmF0ZXMobGluZWFyUmluZykpKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyaW5nLmxlbmd0aCA+PSA0KSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29vcmRzLnB1c2gocmluZyk7CgkgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgaWYgKGNvb3Jkcy5sZW5ndGgpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGdlb21ldHJpZXMucHVzaCh7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogIlBvbHlnb24iLAoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvb3JkaW5hdGVzOiBjb29yZHMsCgkgICAgICAgICAgICAgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgY2FzZSAiVHJhY2siOgoJICAgICAgICAgICAgICAgIGNhc2UgImd4OlRyYWNrIjogewoJICAgICAgICAgICAgICAgICAgICBjb25zdCBneCA9IGd4Q29vcmRzKGNoaWxkKTsKCSAgICAgICAgICAgICAgICAgICAgaWYgKCFneCkKCSAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgICAgICBjb25zdCB7IHRpbWVzLCBnZW9tZXRyeSB9ID0gZ3g7CgkgICAgICAgICAgICAgICAgICAgIGdlb21ldHJpZXMucHVzaChnZW9tZXRyeSk7CgkgICAgICAgICAgICAgICAgICAgIGlmICh0aW1lcy5sZW5ndGgpCgkgICAgICAgICAgICAgICAgICAgICAgICBjb29yZFRpbWVzLnB1c2godGltZXMpOwoJICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIHsKCSAgICAgICAgZ2VvbWV0cmllcywKCSAgICAgICAgY29vcmRUaW1lcywKCSAgICB9OwoJfQoKCWZ1bmN0aW9uIGdlb21ldHJ5TGlzdFRvR2VvbWV0cnkoZ2VvbWV0cmllcykgewoJICAgIHJldHVybiBnZW9tZXRyaWVzLmxlbmd0aCA9PT0gMAoJICAgICAgICA/IG51bGwKCSAgICAgICAgOiBnZW9tZXRyaWVzLmxlbmd0aCA9PT0gMQoJICAgICAgICAgICAgPyBnZW9tZXRyaWVzWzBdCgkgICAgICAgICAgICA6IHsKCSAgICAgICAgICAgICAgICB0eXBlOiAiR2VvbWV0cnlDb2xsZWN0aW9uIiwKCSAgICAgICAgICAgICAgICBnZW9tZXRyaWVzLAoJICAgICAgICAgICAgfTsKCX0KCWZ1bmN0aW9uIGdldFBsYWNlbWFyayhub2RlLCBzdHlsZU1hcCwgc2NoZW1hKSB7CgkgICAgY29uc3QgeyBjb29yZFRpbWVzLCBnZW9tZXRyaWVzIH0gPSBnZXRHZW9tZXRyeShub2RlKTsKCSAgICBjb25zdCBmZWF0dXJlID0gewoJICAgICAgICB0eXBlOiAiRmVhdHVyZSIsCgkgICAgICAgIGdlb21ldHJ5OiBnZW9tZXRyeUxpc3RUb0dlb21ldHJ5KGdlb21ldHJpZXMpLAoJICAgICAgICBwcm9wZXJ0aWVzOiBPYmplY3QuYXNzaWduKGdldE11bHRpKG5vZGUsIFsKCSAgICAgICAgICAgICJuYW1lIiwKCSAgICAgICAgICAgICJhZGRyZXNzIiwKCSAgICAgICAgICAgICJ2aXNpYmlsaXR5IiwKCSAgICAgICAgICAgICJvcGVuIiwKCSAgICAgICAgICAgICJwaG9uZU51bWJlciIsCgkgICAgICAgICAgICAiZGVzY3JpcHRpb24iLAoJICAgICAgICBdKSwgZ2V0TWF5YmVIVE1MRGVzY3JpcHRpb24obm9kZSksIGV4dHJhY3RDYXNjYWRlZFN0eWxlKG5vZGUsIHN0eWxlTWFwKSwgZXh0cmFjdFN0eWxlKG5vZGUpLCBleHRyYWN0RXh0ZW5kZWREYXRhKG5vZGUsIHNjaGVtYSksIGV4dHJhY3RUaW1lU3Bhbihub2RlKSwgZXh0cmFjdFRpbWVTdGFtcChub2RlKSwgY29vcmRUaW1lcy5sZW5ndGgKCSAgICAgICAgICAgID8gewoJICAgICAgICAgICAgICAgIGNvb3JkaW5hdGVQcm9wZXJ0aWVzOiB7CgkgICAgICAgICAgICAgICAgICAgIHRpbWVzOiBjb29yZFRpbWVzLmxlbmd0aCA9PT0gMSA/IGNvb3JkVGltZXNbMF0gOiBjb29yZFRpbWVzLAoJICAgICAgICAgICAgICAgIH0sCgkgICAgICAgICAgICB9CgkgICAgICAgICAgICA6IHt9KSwKCSAgICB9OwoJICAgIGlmIChmZWF0dXJlLnByb3BlcnRpZXM/LnZpc2liaWxpdHkgIT09IHVuZGVmaW5lZCkgewoJICAgICAgICBmZWF0dXJlLnByb3BlcnRpZXMudmlzaWJpbGl0eSA9IGZlYXR1cmUucHJvcGVydGllcy52aXNpYmlsaXR5ICE9PSAiMCI7CgkgICAgfQoJICAgIGNvbnN0IGlkID0gbm9kZS5nZXRBdHRyaWJ1dGUoImlkIik7CgkgICAgaWYgKGlkICE9PSBudWxsICYmIGlkICE9PSAiIikKCSAgICAgICAgZmVhdHVyZS5pZCA9IGlkOwoJICAgIHJldHVybiBmZWF0dXJlOwoJfQoKCWZ1bmN0aW9uIGdldEdyb3VuZE92ZXJsYXlCb3gobm9kZSkgewoJICAgIGNvbnN0IGxhdExvblF1YWQgPSBnZXQxKG5vZGUsICJneDpMYXRMb25RdWFkIik7CgkgICAgaWYgKGxhdExvblF1YWQpIHsKCSAgICAgICAgY29uc3QgcmluZyA9IGZpeFJpbmcoY29vcmQoZ2V0Q29vcmRpbmF0ZXMobm9kZSkpKTsKCSAgICAgICAgcmV0dXJuIHsKCSAgICAgICAgICAgIHR5cGU6ICJQb2x5Z29uIiwKCSAgICAgICAgICAgIGNvb3JkaW5hdGVzOiBbcmluZ10sCgkgICAgICAgIH07CgkgICAgfQoJICAgIHJldHVybiBnZXRMYXRMb25Cb3gobm9kZSk7Cgl9Cgljb25zdCBERUdSRUVTX1RPX1JBRElBTlMgPSBNYXRoLlBJIC8gMTgwOwoJZnVuY3Rpb24gcm90YXRlQm94KGJib3gsIGNvb3JkaW5hdGVzLCByb3RhdGlvbikgewoJICAgIGNvbnN0IGNlbnRlciA9IFsoYmJveFswXSArIGJib3hbMl0pIC8gMiwgKGJib3hbMV0gKyBiYm94WzNdKSAvIDJdOwoJICAgIHJldHVybiBbCgkgICAgICAgIGNvb3JkaW5hdGVzWzBdLm1hcCgoY29vcmRpbmF0ZSkgPT4gewoJICAgICAgICAgICAgY29uc3QgZHkgPSBjb29yZGluYXRlWzFdIC0gY2VudGVyWzFdOwoJICAgICAgICAgICAgY29uc3QgZHggPSBjb29yZGluYXRlWzBdIC0gY2VudGVyWzBdOwoJICAgICAgICAgICAgY29uc3QgZGlzdGFuY2UgPSBNYXRoLnNxcnQoTWF0aC5wb3coZHksIDIpICsgTWF0aC5wb3coZHgsIDIpKTsKCSAgICAgICAgICAgIGNvbnN0IGFuZ2xlID0gTWF0aC5hdGFuMihkeSwgZHgpIC0gcm90YXRpb24gKiBERUdSRUVTX1RPX1JBRElBTlM7CgkgICAgICAgICAgICByZXR1cm4gWwoJICAgICAgICAgICAgICAgIGNlbnRlclswXSArIE1hdGguY29zKGFuZ2xlKSAqIGRpc3RhbmNlLAoJICAgICAgICAgICAgICAgIGNlbnRlclsxXSArIE1hdGguc2luKGFuZ2xlKSAqIGRpc3RhbmNlLAoJICAgICAgICAgICAgXTsKCSAgICAgICAgfSksCgkgICAgXTsKCX0KCWZ1bmN0aW9uIGdldExhdExvbkJveChub2RlKSB7CgkgICAgY29uc3QgbGF0TG9uQm94ID0gZ2V0MShub2RlLCAiTGF0TG9uQm94Iik7CgkgICAgaWYgKGxhdExvbkJveCkgewoJICAgICAgICBjb25zdCBub3J0aCA9IG51bTEobGF0TG9uQm94LCAibm9ydGgiKTsKCSAgICAgICAgY29uc3Qgd2VzdCA9IG51bTEobGF0TG9uQm94LCAid2VzdCIpOwoJICAgICAgICBjb25zdCBlYXN0ID0gbnVtMShsYXRMb25Cb3gsICJlYXN0Iik7CgkgICAgICAgIGNvbnN0IHNvdXRoID0gbnVtMShsYXRMb25Cb3gsICJzb3V0aCIpOwoJICAgICAgICBjb25zdCByb3RhdGlvbiA9IG51bTEobGF0TG9uQm94LCAicm90YXRpb24iKTsKCSAgICAgICAgaWYgKHR5cGVvZiBub3J0aCA9PT0gIm51bWJlciIgJiYKCSAgICAgICAgICAgIHR5cGVvZiBzb3V0aCA9PT0gIm51bWJlciIgJiYKCSAgICAgICAgICAgIHR5cGVvZiB3ZXN0ID09PSAibnVtYmVyIiAmJgoJICAgICAgICAgICAgdHlwZW9mIGVhc3QgPT09ICJudW1iZXIiKSB7CgkgICAgICAgICAgICBjb25zdCBiYm94ID0gW3dlc3QsIHNvdXRoLCBlYXN0LCBub3J0aF07CgkgICAgICAgICAgICBsZXQgY29vcmRpbmF0ZXMgPSBbCgkgICAgICAgICAgICAgICAgWwoJICAgICAgICAgICAgICAgICAgICBbd2VzdCwgbm9ydGhdLAoJICAgICAgICAgICAgICAgICAgICBbZWFzdCwgbm9ydGhdLAoJICAgICAgICAgICAgICAgICAgICBbZWFzdCwgc291dGhdLAoJICAgICAgICAgICAgICAgICAgICBbd2VzdCwgc291dGhdLAoJICAgICAgICAgICAgICAgICAgICBbd2VzdCwgbm9ydGhdLCAvLyB0b3AgbGVmdCAoYWdhaW4pCgkgICAgICAgICAgICAgICAgXSwKCSAgICAgICAgICAgIF07CgkgICAgICAgICAgICBpZiAodHlwZW9mIHJvdGF0aW9uID09PSAibnVtYmVyIikgewoJICAgICAgICAgICAgICAgIGNvb3JkaW5hdGVzID0gcm90YXRlQm94KGJib3gsIGNvb3JkaW5hdGVzLCByb3RhdGlvbik7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gewoJICAgICAgICAgICAgICAgIHR5cGU6ICJQb2x5Z29uIiwKCSAgICAgICAgICAgICAgICBjb29yZGluYXRlcywKCSAgICAgICAgICAgIH07CgkgICAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIG51bGw7Cgl9CglmdW5jdGlvbiBnZXRHcm91bmRPdmVybGF5KG5vZGUsIHN0eWxlTWFwLCBzY2hlbWEpIHsKCSAgICBjb25zdCBnZW9tZXRyeSA9IGdldEdyb3VuZE92ZXJsYXlCb3gobm9kZSk7CgkgICAgY29uc3QgZmVhdHVyZSA9IHsKCSAgICAgICAgdHlwZTogIkZlYXR1cmUiLAoJICAgICAgICBnZW9tZXRyeSwKCSAgICAgICAgcHJvcGVydGllczogT2JqZWN0LmFzc2lnbigKCSAgICAgICAgLyoqCgkgICAgICAgICAqIFJlbGF0ZWQgdG8KCSAgICAgICAgICogaHR0cHM6Ly9naXN0LmdpdGh1Yi5jb20vdG1jdy8wMzdhMWNiNjY2MGQ3NGEzOTJlOWRhNzQ0NjU0MGY0NgoJICAgICAgICAgKi8KCSAgICAgICAgeyAiQGdlb21ldHJ5LXR5cGUiOiAiZ3JvdW5kb3ZlcmxheSIgfSwgZ2V0TXVsdGkobm9kZSwgWwoJICAgICAgICAgICAgIm5hbWUiLAoJICAgICAgICAgICAgImFkZHJlc3MiLAoJICAgICAgICAgICAgInZpc2liaWxpdHkiLAoJICAgICAgICAgICAgIm9wZW4iLAoJICAgICAgICAgICAgInBob25lTnVtYmVyIiwKCSAgICAgICAgICAgICJkZXNjcmlwdGlvbiIsCgkgICAgICAgIF0pLCBnZXRNYXliZUhUTUxEZXNjcmlwdGlvbihub2RlKSwgZXh0cmFjdENhc2NhZGVkU3R5bGUobm9kZSwgc3R5bGVNYXApLCBleHRyYWN0U3R5bGUobm9kZSksIGV4dHJhY3RJY29uSHJlZihub2RlKSwgZXh0cmFjdEV4dGVuZGVkRGF0YShub2RlLCBzY2hlbWEpLCBleHRyYWN0VGltZVNwYW4obm9kZSksIGV4dHJhY3RUaW1lU3RhbXAobm9kZSkpLAoJICAgIH07CgkgICAgaWYgKGZlYXR1cmUucHJvcGVydGllcz8udmlzaWJpbGl0eSAhPT0gdW5kZWZpbmVkKSB7CgkgICAgICAgIGZlYXR1cmUucHJvcGVydGllcy52aXNpYmlsaXR5ID0gZmVhdHVyZS5wcm9wZXJ0aWVzLnZpc2liaWxpdHkgIT09ICIwIjsKCSAgICB9CgkgICAgY29uc3QgaWQgPSBub2RlLmdldEF0dHJpYnV0ZSgiaWQiKTsKCSAgICBpZiAoaWQgIT09IG51bGwgJiYgaWQgIT09ICIiKQoJICAgICAgICBmZWF0dXJlLmlkID0gaWQ7CgkgICAgcmV0dXJuIGZlYXR1cmU7Cgl9CgoJZnVuY3Rpb24gZ2V0U3R5bGVJZChzdHlsZSkgewoJICAgIGxldCBpZCA9IHN0eWxlLmdldEF0dHJpYnV0ZSgiaWQiKTsKCSAgICBjb25zdCBwYXJlbnROb2RlID0gc3R5bGUucGFyZW50Tm9kZTsKCSAgICBpZiAoIWlkICYmCgkgICAgICAgIGlzRWxlbWVudChwYXJlbnROb2RlKSAmJgoJICAgICAgICBwYXJlbnROb2RlLmxvY2FsTmFtZSA9PT0gIkNhc2NhZGluZ1N0eWxlIikgewoJICAgICAgICBpZCA9IHBhcmVudE5vZGUuZ2V0QXR0cmlidXRlKCJrbWw6aWQiKSB8fCBwYXJlbnROb2RlLmdldEF0dHJpYnV0ZSgiaWQiKTsKCSAgICB9CgkgICAgcmV0dXJuIG5vcm1hbGl6ZUlkKGlkIHx8ICIiKTsKCX0KCWZ1bmN0aW9uIGJ1aWxkU3R5bGVNYXAobm9kZSkgewoJICAgIGNvbnN0IHN0eWxlTWFwID0ge307CgkgICAgZm9yIChjb25zdCBzdHlsZSBvZiAkKG5vZGUsICJTdHlsZSIpKSB7CgkgICAgICAgIHN0eWxlTWFwW2dldFN0eWxlSWQoc3R5bGUpXSA9IGV4dHJhY3RTdHlsZShzdHlsZSk7CgkgICAgfQoJICAgIGZvciAoY29uc3QgbWFwIG9mICQobm9kZSwgIlN0eWxlTWFwIikpIHsKCSAgICAgICAgY29uc3QgaWQgPSBub3JtYWxpemVJZChtYXAuZ2V0QXR0cmlidXRlKCJpZCIpIHx8ICIiKTsKCSAgICAgICAgdmFsMShtYXAsICJzdHlsZVVybCIsIChzdHlsZVVybCkgPT4gewoJICAgICAgICAgICAgc3R5bGVVcmwgPSBub3JtYWxpemVJZChzdHlsZVVybCk7CgkgICAgICAgICAgICBpZiAoc3R5bGVNYXBbc3R5bGVVcmxdKSB7CgkgICAgICAgICAgICAgICAgc3R5bGVNYXBbaWRdID0gc3R5bGVNYXBbc3R5bGVVcmxdOwoJICAgICAgICAgICAgfQoJICAgICAgICB9KTsKCSAgICB9CgkgICAgcmV0dXJuIHN0eWxlTWFwOwoJfQoJZnVuY3Rpb24gYnVpbGRTY2hlbWEobm9kZSkgewoJICAgIGNvbnN0IHNjaGVtYSA9IHt9OwoJICAgIGZvciAoY29uc3QgZmllbGQgb2YgJChub2RlLCAiU2ltcGxlRmllbGQiKSkgewoJICAgICAgICBzY2hlbWFbZmllbGQuZ2V0QXR0cmlidXRlKCJuYW1lIikgfHwgIiJdID0KCSAgICAgICAgICAgIHR5cGVDb252ZXJ0ZXJzW2ZpZWxkLmdldEF0dHJpYnV0ZSgidHlwZSIpIHx8ICIiXSB8fAoJICAgICAgICAgICAgICAgIHR5cGVDb252ZXJ0ZXJzWyJzdHJpbmciXTsKCSAgICB9CgkgICAgcmV0dXJuIHNjaGVtYTsKCX0KCWNvbnN0IEZPTERFUl9QUk9QUyA9IFsKCSAgICAibmFtZSIsCgkgICAgInZpc2liaWxpdHkiLAoJICAgICJvcGVuIiwKCSAgICAiYWRkcmVzcyIsCgkgICAgImRlc2NyaXB0aW9uIiwKCSAgICAicGhvbmVOdW1iZXIiLAoJICAgICJ2aXNpYmlsaXR5IiwKCV07CglmdW5jdGlvbiBnZXRGb2xkZXIobm9kZSkgewoJICAgIGNvbnN0IG1ldGEgPSB7fTsKCSAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIEFycmF5LmZyb20obm9kZS5jaGlsZE5vZGVzKSkgewoJICAgICAgICBpZiAoaXNFbGVtZW50KGNoaWxkKSAmJiBGT0xERVJfUFJPUFMuaW5jbHVkZXMoY2hpbGQudGFnTmFtZSkpIHsKCSAgICAgICAgICAgIG1ldGFbY2hpbGQudGFnTmFtZV0gPSBub2RlVmFsKGNoaWxkKTsKCSAgICAgICAgfQoJICAgIH0KCSAgICByZXR1cm4gewoJICAgICAgICB0eXBlOiAiZm9sZGVyIiwKCSAgICAgICAgbWV0YSwKCSAgICAgICAgY2hpbGRyZW46IFtdLAoJICAgIH07Cgl9CgkvKioKCSAqIFlpZWxkIGEgbmVzdGVkIHRyZWUgd2l0aCBLTUwgZm9sZGVyIHN0cnVjdHVyZQoJICoKCSAqIFRoaXMgZ2VuZXJhdGVzIGEgdHJlZSB3aXRoIHRoZSBnaXZlbiBzdHJ1Y3R1cmU6CgkgKgoJICogYGBganMKCSAqIHsKCSAqICAgInR5cGUiOiAicm9vdCIsCgkgKiAgICJjaGlsZHJlbiI6IFsKCSAqICAgICB7CgkgKiAgICAgICAidHlwZSI6ICJmb2xkZXIiLAoJICogICAgICAgIm1ldGEiOiB7CgkgKiAgICAgICAgICJuYW1lIjogIlRlc3QiCgkgKiAgICAgICB9LAoJICogICAgICAgImNoaWxkcmVuIjogWwoJICogICAgICAgICAgLy8gLi4uZmVhdHVyZXMgYW5kIGZvbGRlcnMKCSAqICAgICAgIF0KCSAqICAgICB9CgkgKiAgICAgLy8gLi4uZmVhdHVyZXMKCSAqICAgXQoJICogfQoJICogYGBgCgkgKgoJICogIyMjIEdyb3VuZE92ZXJsYXkKCSAqCgkgKiBHcm91bmRPdmVybGF5IGVsZW1lbnRzIGFyZSBjb252ZXJ0ZWQgaW50bwoJICogYEZlYXR1cmVgIG9iamVjdHMgd2l0aCBgUG9seWdvbmAgZ2VvbWV0cmllcywKCSAqIGEgcHJvcGVydHkgbGlrZToKCSAqCgkgKiBgYGBqc29uCgkgKiB7CgkgKiAgICJAZ2VvbWV0cnktdHlwZSI6ICJncm91bmRvdmVybGF5IgoJICogfQoJICogYGBgCgkgKgoJICogQW5kIHRoZSBncm91bmQgb3ZlcmxheSdzIGltYWdlIFVSTCBpbiB0aGUgYGhyZWZgCgkgKiBwcm9wZXJ0eS4gR3JvdW5kIG92ZXJsYXlzIHdpbGwgbmVlZCB0byBiZSBkaXNwbGF5ZWQKCSAqIHdpdGggYSBzZXBhcmF0ZSBtZXRob2QgdG8gb3RoZXIgZmVhdHVyZXMsIGRlcGVuZGluZwoJICogb24gd2hpY2ggbWFwIGZyYW1ld29yayB5b3UncmUgdXNpbmcuCgkgKi8KCWZ1bmN0aW9uIGttbFdpdGhGb2xkZXJzKG5vZGUpIHsKCSAgICBjb25zdCBzdHlsZU1hcCA9IGJ1aWxkU3R5bGVNYXAobm9kZSk7CgkgICAgY29uc3Qgc2NoZW1hID0gYnVpbGRTY2hlbWEobm9kZSk7CgkgICAgY29uc3QgdHJlZSA9IHsgdHlwZTogInJvb3QiLCBjaGlsZHJlbjogW10gfTsKCSAgICBmdW5jdGlvbiB0cmF2ZXJzZShub2RlLCBwb2ludGVyKSB7CgkgICAgICAgIGlmIChpc0VsZW1lbnQobm9kZSkpIHsKCSAgICAgICAgICAgIHN3aXRjaCAobm9kZS50YWdOYW1lKSB7CgkgICAgICAgICAgICAgICAgY2FzZSAiR3JvdW5kT3ZlcmxheSI6IHsKCSAgICAgICAgICAgICAgICAgICAgY29uc3QgcGxhY2VtYXJrID0gZ2V0R3JvdW5kT3ZlcmxheShub2RlLCBzdHlsZU1hcCwgc2NoZW1hKTsKCSAgICAgICAgICAgICAgICAgICAgaWYgKHBsYWNlbWFyaykgewoJICAgICAgICAgICAgICAgICAgICAgICAgcG9pbnRlci5jaGlsZHJlbi5wdXNoKHBsYWNlbWFyayk7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIGNhc2UgIlBsYWNlbWFyayI6IHsKCSAgICAgICAgICAgICAgICAgICAgY29uc3QgcGxhY2VtYXJrID0gZ2V0UGxhY2VtYXJrKG5vZGUsIHN0eWxlTWFwLCBzY2hlbWEpOwoJICAgICAgICAgICAgICAgICAgICBpZiAocGxhY2VtYXJrKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBwb2ludGVyLmNoaWxkcmVuLnB1c2gocGxhY2VtYXJrKTsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgY2FzZSAiRm9sZGVyIjogewoJICAgICAgICAgICAgICAgICAgICBjb25zdCBmb2xkZXIgPSBnZXRGb2xkZXIobm9kZSk7CgkgICAgICAgICAgICAgICAgICAgIHBvaW50ZXIuY2hpbGRyZW4ucHVzaChmb2xkZXIpOwoJICAgICAgICAgICAgICAgICAgICBwb2ludGVyID0gZm9sZGVyOwoJICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICAgICAgaWYgKG5vZGUuY2hpbGROb2RlcykgewoJICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2RlLmNoaWxkTm9kZXMubGVuZ3RoOyBpKyspIHsKCSAgICAgICAgICAgICAgICB0cmF2ZXJzZShub2RlLmNoaWxkTm9kZXNbaV0sIHBvaW50ZXIpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgfQoJICAgIHRyYXZlcnNlKG5vZGUsIHRyZWUpOwoJICAgIHJldHVybiB0cmVlOwoJfQoJLyoqCgkgKiBDb252ZXJ0IEtNTCB0byBHZW9KU09OIGluY3JlbWVudGFsbHksIHJldHVybmluZwoJICogYSBbR2VuZXJhdG9yXShodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9KYXZhU2NyaXB0L0d1aWRlL0l0ZXJhdG9yc19hbmRfR2VuZXJhdG9ycykKCSAqIHRoYXQgeWllbGRzIG91dHB1dCBmZWF0dXJlIGJ5IGZlYXR1cmUuCgkgKi8KCWZ1bmN0aW9uKiBrbWxHZW4obm9kZSkgewoJICAgIGNvbnN0IHN0eWxlTWFwID0gYnVpbGRTdHlsZU1hcChub2RlKTsKCSAgICBjb25zdCBzY2hlbWEgPSBidWlsZFNjaGVtYShub2RlKTsKCSAgICBmb3IgKGNvbnN0IHBsYWNlbWFyayBvZiAkKG5vZGUsICJQbGFjZW1hcmsiKSkgewoJICAgICAgICBjb25zdCBmZWF0dXJlID0gZ2V0UGxhY2VtYXJrKHBsYWNlbWFyaywgc3R5bGVNYXAsIHNjaGVtYSk7CgkgICAgICAgIGlmIChmZWF0dXJlKQoJICAgICAgICAgICAgeWllbGQgZmVhdHVyZTsKCSAgICB9CgkgICAgZm9yIChjb25zdCBncm91bmRPdmVybGF5IG9mICQobm9kZSwgIkdyb3VuZE92ZXJsYXkiKSkgewoJICAgICAgICBjb25zdCBmZWF0dXJlID0gZ2V0R3JvdW5kT3ZlcmxheShncm91bmRPdmVybGF5LCBzdHlsZU1hcCwgc2NoZW1hKTsKCSAgICAgICAgaWYgKGZlYXR1cmUpCgkgICAgICAgICAgICB5aWVsZCBmZWF0dXJlOwoJICAgIH0KCX0KCS8qKgoJICogQ29udmVydCBhIEtNTCBkb2N1bWVudCB0byBHZW9KU09OLiBUaGUgZmlyc3QgYXJndW1lbnQsIGBkb2NgLCBtdXN0IGJlIGEgS01MCgkgKiBkb2N1bWVudCBhcyBhbiBYTUwgRE9NIC0gbm90IGFzIGEgc3RyaW5nLiBZb3UgY2FuIGdldCB0aGlzIHVzaW5nIGpRdWVyeSdzIGRlZmF1bHQKCSAqIGAuYWpheGAgZnVuY3Rpb24gb3IgdXNpbmcgYSBiYXJlIFhNTEh0dHBSZXF1ZXN0IHdpdGggdGhlIGAucmVzcG9uc2VgIHByb3BlcnR5CgkgKiBob2xkaW5nIGFuIFhNTCBET00uCgkgKgoJICogVGhlIG91dHB1dCBpcyBhIEphdmFTY3JpcHQgb2JqZWN0IG9mIEdlb0pTT04gZGF0YS4gWW91IGNhbiBjb252ZXJ0IGl0IHRvIGEgc3RyaW5nCgkgKiB3aXRoIFtKU09OLnN0cmluZ2lmeV0oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvSlNPTi9zdHJpbmdpZnkpCgkgKiBvciB1c2UgaXQgZGlyZWN0bHkgaW4gbGlicmFyaWVzLgoJICovCglmdW5jdGlvbiBrbWwobm9kZSkgewoJICAgIHJldHVybiB7CgkgICAgICAgIHR5cGU6ICJGZWF0dXJlQ29sbGVjdGlvbiIsCgkgICAgICAgIGZlYXR1cmVzOiBBcnJheS5mcm9tKGttbEdlbihub2RlKSksCgkgICAgfTsKCX0KCgl2YXIgdG9HZW9Kc29uID0gLyojX19QVVJFX18qL09iamVjdC5mcmVlemUoewoJCV9fcHJvdG9fXzogbnVsbCwKCQlncHg6IGdweCwKCQlncHhHZW46IGdweEdlbiwKCQlrbWw6IGttbCwKCQlrbWxHZW46IGttbEdlbiwKCQlrbWxXaXRoRm9sZGVyczoga21sV2l0aEZvbGRlcnMsCgkJdGN4OiB0Y3gsCgkJdGN4R2VuOiB0Y3hHZW4KCX0pOwoKCWNsYXNzIENvbnZlcnRlciB7CgkgICAgY29uc3RydWN0b3IoZm9ybWF0LCBkYXRhKSB7CgkgICAgICAgIC8qKgoJICAgICAgICAgKiBDcmVhdGVzIGEgYmxhbmsgR2VvSlNPTiBmZWF0dXJlIGNvbGxlY3Rpb24uCgkgICAgICAgICAqIEByZXR1cm5zIEEgbmV3IEdlb0pTT04gZmVhdHVyZSBjb2xsZWN0aW9uIHdpdGggbm8gZmVhdHVyZXMuCgkgICAgICAgICAqLwoJICAgICAgICB0aGlzLmJsYW5rR2VvSlNPTiA9ICgpID0+ICh7CgkgICAgICAgICAgICB0eXBlOiAnRmVhdHVyZUNvbGxlY3Rpb24nLAoJICAgICAgICAgICAgZmVhdHVyZXM6IFtdLAoJICAgICAgICB9KTsKCSAgICAgICAgdGhpcy5fcmF3RGF0YSA9IGRhdGE7CgkgICAgICAgIHRoaXMuX2Zvcm1hdCA9IGZvcm1hdDsKCSAgICAgICAgY29uc3QgY29udmVydGVycyA9IHsKCSAgICAgICAgICAgICd0b3BvanNvbic6IHRoaXMubG9hZFRvcG9Kc29uLAoJICAgICAgICAgICAgJ2ttbCc6IHRoaXMubG9hZFhtbCwKCSAgICAgICAgICAgICdncHgnOiB0aGlzLmxvYWRYbWwsCgkgICAgICAgICAgICAndGN4JzogdGhpcy5sb2FkWG1sLAoJICAgICAgICAgICAgJ2Nzdic6IHRoaXMubG9hZENzdiwKCSAgICAgICAgICAgICd0c3YnOiB0aGlzLmxvYWRDc3YKCSAgICAgICAgfTsKCSAgICAgICAgdGhpcy5fY29udmVyc2lvbkZuID0gY29udmVydGVyc1tmb3JtYXRdOwoJICAgIH0KCSAgICBhc3luYyBjb252ZXJ0KCkgewoJICAgICAgICBpZiAoIXRoaXMuX2NvbnZlcnNpb25GbikgewoJICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChfLCByZWopID0+IHJlaihgTm8gY29udmVydGVyIGV4aXN0cyBmb3IgJHt0aGlzLl9mb3JtYXR9YCkpOwoJICAgICAgICB9CgkgICAgICAgIGVsc2UgewoJICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2NvbnZlcnNpb25GbigpOwoJICAgICAgICB9CgkgICAgfQoJICAgIC8qKgoJICAgICAqIExvYWQgdGhlIFhNTCBkYXRhIGFzIEdlb0pTT04KCSAgICAgKiBAcmV0dXJucyBBIHByb21pc2UgcmVzb2x2aW5nIHRvIGEgR2VvSlNPTiBGZWF0dXJlQ29sbGVjdGlvbgoJICAgICAqLwoJICAgIGFzeW5jIGxvYWRYbWwoKSB7CgkgICAgICAgIC8vIFVzZSB0aGUgYXBwcm9wcmlhdGUgcGFyc2VyIGJhc2VkIG9uIHRoZSBmb3JtYXQKCSAgICAgICAgY29uc3QgZ2VvanNvbiA9IHRvR2VvSnNvblt0aGlzLl9mb3JtYXRdKG5ldyBET01QYXJzZXIoKS5wYXJzZUZyb21TdHJpbmcodGhpcy5fcmF3RGF0YSwgInRleHQveG1sIikpOwoJICAgICAgICByZXR1cm4gZ2VvanNvbjsKCSAgICB9CgkgICAgLyoqCgkgICAgICogTG9hZHMgYW5kIHBhcnNlcyBDU1YgZGF0YSBpbnRvIGEgR2VvSlNPTiBGZWF0dXJlQ29sbGVjdGlvbi4KCSAgICAgKiBAcmV0dXJucyBBIFByb21pc2UgdGhhdCByZXNvbHZlcyB3aXRoIHRoZSBHZW9KU09OIEZlYXR1cmVDb2xsZWN0aW9uLgoJICAgICAqLwoJICAgIGFzeW5jIGxvYWRDc3YoKSB7CgkgICAgICAgIC8vIERlZmluZSBvcHRpb25zIGZvciB0aGUgY3N2Mmdlb2pzb24gbGlicmFyeQoJICAgICAgICBsZXQgb3B0aW9ucyA9IHt9OyAvLyBUT0RPIGFsbG93IENTViBvcHRpb25zCgkgICAgICAgIGlmICh0aGlzLl9mb3JtYXQgPT09ICd0c3YnKSB7CgkgICAgICAgICAgICBvcHRpb25zLmRlbGltaXRlciA9ICdcdCc7CgkgICAgICAgIH0KCSAgICAgICAgLy8gVXNlIHRoZSBjc3YyZ2VvanNvbiBsaWJyYXJ5IHRvIGNvbnZlcnQgdGhlIENTViB0byBHZW9KU09OCgkgICAgICAgIGNvbnN0IGdlb2pzb24gPSBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CgkgICAgICAgICAgICBjc3YyZ2VvanNvbl8xLmNzdjJnZW9qc29uKHRoaXMuX3Jhd0RhdGEsIG9wdGlvbnMsIChlcnIsIGRhdGEpID0+IHsKCSAgICAgICAgICAgICAgICBpZiAoZXJyKSB7CgkgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICBlbHNlIHsKCSAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9KTsKCSAgICAgICAgfSk7CgkgICAgICAgIHJldHVybiBnZW9qc29uOwoJICAgIH0KCSAgICAvKioKCSAgICAgKiBMb2FkcyBUb3BvSlNPTiBkYXRhIGFuZCBjb252ZXJ0cyBpdCBpbnRvIGEgR2VvSlNPTiBGZWF0dXJlQ29sbGVjdGlvbgoJICAgICAqLwoJICAgIGFzeW5jIGxvYWRUb3BvSnNvbigpIHsKCSAgICAgICAgbGV0IHRvcG9Kc29uRGF0YSA9IHt9OwoJICAgICAgICB0cnkgewoJICAgICAgICAgICAgdG9wb0pzb25EYXRhID0gSlNPTi5wYXJzZSh0aGlzLl9yYXdEYXRhKTsKCSAgICAgICAgfQoJICAgICAgICBjYXRjaCAoZSkgewoJICAgICAgICAgICAgdGhyb3cgIkludmFsaWQgVG9wb0pzb24iOwoJICAgICAgICB9CgkgICAgICAgIC8vIENvbnZlcnQgdGhlIGRhdGEKCSAgICAgICAgbGV0IHJlc3VsdCA9IHRoaXMuYmxhbmtHZW9KU09OKCk7CgkgICAgICAgIGlmICh0b3BvSnNvbkRhdGEudHlwZSA9PT0gIlRvcG9sb2d5IiAmJiB0b3BvSnNvbkRhdGEub2JqZWN0cyAhPT0gdW5kZWZpbmVkKSB7CgkgICAgICAgICAgICByZXN1bHQgPSB7CgkgICAgICAgICAgICAgICAgdHlwZTogIkZlYXR1cmVDb2xsZWN0aW9uIiwKCSAgICAgICAgICAgICAgICBmZWF0dXJlczogcmVzdWx0LmZlYXR1cmVzID0gT2JqZWN0LmtleXModG9wb0pzb25EYXRhLm9iamVjdHMpLm1hcChrZXkgPT4gdG9wb2pzb25GZWF0dXJlKHRvcG9Kc29uRGF0YSwga2V5KSkucmVkdWNlKChhLCB2KSA9PiBbLi4uYSwgLi4udi5mZWF0dXJlc10sIFtdKQoJICAgICAgICAgICAgfTsKCSAgICAgICAgfQoJICAgICAgICByZXR1cm4gcmVzdWx0OwoJICAgIH0KCSAgICA7Cgl9CgoJY29uc3QgbGlicmFyaWVzID0gewoJICAgICdDb252ZXJ0ZXInOiBDb252ZXJ0ZXIKCX07CglsZXQgc3ViQ2xhc3M7CglzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCBlID0+IHsKCSAgICBjb25zdCBkYXRhID0gKGUuZGF0YSB8fCBlKTsKCSAgICBjb25zdCBwb3N0ID0gKGlkLCBlcnIsIHJlcywgdHlwZSkgPT4gewoJICAgICAgICBwb3N0TWVzc2FnZSh7CgkgICAgICAgICAgICB0eXBlOiB0eXBlID8gdHlwZSA6IChlcnIgPyAnZXJyb3InIDogJ3Jlc3BvbnNlJyksCgkgICAgICAgICAgICBpZDogaWQsCgkgICAgICAgICAgICBtZXNzYWdlOiByZXMsCgkgICAgICAgICAgICBlcnJvcjogZXJyCgkgICAgICAgIH0pOwoJICAgIH07CgkgICAgY29uc3QgY29tbWFuZHMgPSB7CgkgICAgICAgICdpbml0JzogKG1zZykgPT4gewoJICAgICAgICAgICAgY29uc3QgeyBpZCwgY29tbWFuZCwgbWVzc2FnZSB9ID0gbXNnOwoJICAgICAgICAgICAgc3ViQ2xhc3MgPSBuZXcgbGlicmFyaWVzW2NvbW1hbmRdKG1lc3NhZ2VbMF0sIG1lc3NhZ2VbMV0pOwoJICAgICAgICAgICAgLy8gcmV0dXJuIHRoZSBjbGFzcycgbWV0aG9kcwoJICAgICAgICAgICAgY29uc3QgZm5zID0gWwoJICAgICAgICAgICAgICAgIC4uLk9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKGxpYnJhcmllc1tjb21tYW5kXS5wcm90b3R5cGUpLAoJICAgICAgICAgICAgICAgIC4uLk9iamVjdC5rZXlzKHN1YkNsYXNzKQoJICAgICAgICAgICAgXS5tYXAoa2V5ID0+IFtrZXksIHR5cGVvZiBsaWJyYXJpZXNbY29tbWFuZF0ucHJvdG90eXBlW2tleV1dKQoJICAgICAgICAgICAgICAgIC5yZWR1Y2UoKGEsIGMpID0+ICh7IC4uLmEsIC4uLnsgW2NbMF1dOiBjWzFdIH0gfSksIHt9KTsKCSAgICAgICAgICAgIHBvc3QoaWQsIHVuZGVmaW5lZCwgZm5zLCAnaW5pdF9yZXNwb25zZScpOwoJICAgICAgICB9LAoJICAgICAgICAnZ2V0JzogZnVuY3Rpb24gKG1zZykgewoJICAgICAgICAgICAgY29uc3QgeyBpZCwgY29tbWFuZCB9ID0gbXNnOwoJICAgICAgICAgICAgaWYgKHN1YkNsYXNzICYmIHN1YkNsYXNzW2NvbW1hbmRdKSB7CgkgICAgICAgICAgICAgICAgcG9zdChpZCwgdW5kZWZpbmVkLCBzdWJDbGFzc1tjb21tYW5kXSk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBlbHNlIHsKCSAgICAgICAgICAgICAgICBwb3N0KGlkLCB1bmRlZmluZWQsIHVuZGVmaW5lZCk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0sCgkgICAgICAgICdleGVjJzogZnVuY3Rpb24gKG1zZykgewoJICAgICAgICAgICAgY29uc3QgeyBpZCwgY29tbWFuZCwgbWVzc2FnZSB9ID0gbXNnOwoJICAgICAgICAgICAgaWYgKHN1YkNsYXNzICYmIHN1YkNsYXNzW2NvbW1hbmRdICYmIHR5cGVvZiBzdWJDbGFzc1tjb21tYW5kXSA9PT0gJ2Z1bmN0aW9uJykgewoJICAgICAgICAgICAgICAgIGNvbnN0IGNtZCA9IHN1YkNsYXNzW2NvbW1hbmRdCgkgICAgICAgICAgICAgICAgICAgIC5hcHBseShzdWJDbGFzcywgbWVzc2FnZSk7CgkgICAgICAgICAgICAgICAgaWYgKCEhY21kICYmIHR5cGVvZiBjbWQudGhlbiA9PT0gJ2Z1bmN0aW9uJykgewoJICAgICAgICAgICAgICAgICAgICAvLyBJdCdzIGEgcHJvbWlzZSwgc28gd2FpdCBmb3IgaXQKCSAgICAgICAgICAgICAgICAgICAgY21kCgkgICAgICAgICAgICAgICAgICAgICAgICAudGhlbihyZXMgPT4gcG9zdChpZCwgdW5kZWZpbmVkLCByZXMpKQoJICAgICAgICAgICAgICAgICAgICAgICAgLmNhdGNoKGUgPT4gcG9zdChpZCwgZSkpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICBlbHNlIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gTm90IGEgcHJvbWlzZSwganVzdCByZXR1cm4gaXQKCSAgICAgICAgICAgICAgICAgICAgcG9zdChpZCwgdW5kZWZpbmVkLCBjbWQpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGVsc2UgewoJICAgICAgICAgICAgICAgIC8vIEVycm9yCgkgICAgICAgICAgICAgICAgcG9zdChpZCwgbmV3IEVycm9yKGBjb21tYW5kICIke2NvbW1hbmR9IiBub3QgZm91bmRgKSk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICB9OwoJICAgIGlmIChjb21tYW5kc1tkYXRhLnR5cGVdKSB7CgkgICAgICAgIGNvbW1hbmRzW2RhdGEudHlwZV0oZGF0YSk7CgkgICAgfQoJfSk7Cgp9KSgpOwoK",Og=null,Mg=!1,Ug?Qg(jg,Og,Mg):function(g,I,C){var A;return function(l){return A=A||Tg(g,I,C),new Worker(A,l)}}(jg,Og,Mg));const Dg=()=>Math.random().toString(36).substring(2);class Eg{constructor(g,I){this.initId=Dg()+"-"+g,this.worker=new Pg,this.handlers=new Map,this.worker.onmessage=I=>{const C=I.data,A=this.handlers.get(C.id),l=this;if(A){if("response"===C.type&&A.resolve(C.message),"error"===C.type){const I=C.error||new Error(`Unknown error with ${g}`);A.reject(I)}"init_response"===C.type&&(this._=Object.keys(C.message).map((g=>{const I="function"==typeof C.message[g];return[g,function(){return I?l.exec(g)(...arguments):l.get(g)}]})).reduce(((g,I)=>({...g,[I[0]]:I[1]})),{}),A.resolve(this._))}},this.worker.postMessage({type:"init",id:this.initId,command:g,message:I})}onLoad(){return new Promise((g=>{void 0===this._?this.handlers.set(this.initId,{resolve:g,reject:g}):g(this._)}))}exec(g){const I=this;return function(...C){return new Promise(((A,l)=>{const b=Dg()+"-"+g;I.handlers.set(b,{resolve:A,reject:l}),I.worker.postMessage({type:"exec",id:b,command:g,message:[...C]})}))}}get(g){return new Promise(((I,C)=>{const A=Dg()+"-"+g;this.handlers.set(A,{resolve:I,reject:C}),this.worker.postMessage({type:"get",id:A,command:g,message:[]})}))}}const qg="test://http://example.com"!==new URL("test://http://example.com").href,_g=(g,I)=>{const C=new AbortController,A=g.url.split("://")[0],l=g.url.replace(new RegExp(`^${A}://`),""),b=qg?(g=>{const I=new RegExp("^(https?)(//)");return g.replace(I,"$1:$2")})(l):l;return b&&fetch(b,{signal:C.signal}).then((g=>{200==g.status?g.text().then((g=>{let C,l;["kml","tcx","gpx"].indexOf(A)>=0||!(()=>{let g=!1;try{g="function"==typeof window.Worker}catch(I){g=!1}return g})()?(C=new fg(A,g),l=C.convert()):(C=new Eg("Converter",[A,g]),l=C.exec("convert")()),l.then((g=>{I(null,g,null,null)})).catch((g=>{I(g)}))})):I(new Error(`Data fetch error: ${g.statusText}`))})).catch((g=>{I(new Error(g))})),{cancel:()=>{C.abort()}}};g.VectorTextProtocol=_g,g.addProtocols=g=>{zg.forEach((I=>{g.addProtocol(I,_g)}))},Object.defineProperty(g,"__esModule",{value:!0})}));
//# sourceMappingURL=maplibre-gl-vector-text-protocol.min.js.map
