<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>cyclemap</title>
	<link rel="stylesheet" type="text/css" href="mapbox-gl.css" />
	<script src="mapbox-gl.js"></script>
	<script src="js.cookie.min.js"></script>
	<style>
		body {
			margin: 0;
			padding: 0;
		}
		.map {
			position: absolute;
			top: 0;
			bottom: 0;
			width: 100%;
		}
		.mapboxgl-ctrl-scale {
			pointer-events: none;
		}
		.about {
			position: absolute;
			top: 0;
			height: 20px;
			padding: 1px;
			background: hsla(0, 0%, 100%, 50%);
			font-size: larger;
			z-index: 2;
		}
		.legend {
			position: absolute;
			display: inline-block;
			left: 110px;
			bottom: 2px;
			pointer-events: none;
			font-size: small;
			z-index: 2;
		}
		.pathLegend {
			display: inline-block;
			padding: 1px;
			background: hsla(0, 0%, 100%, 75%);
		}
		.pathLegendColor {
			display: inline-block;
			text-shadow: -1px 0 black, 0 1px black, 1px 0 black, 0 -1px black;
		}
		.legendItem {
			display: inline-block;
		}
		#footLegend {
			display: inline-block;
			transition: opacity 2s;
		}
		.iconLegend {
			display: inline-block;
			bottom: 0px;
			background: hsla(0, 0%, 100%, 75%);
		}
		.icon {
			display: inline-block;
			background: url(sprite/sprite@2x.png) no-repeat;
			width: 34px;
			height: 28px;
			vertical-align: middle;
			transform: scale(.75);
		}
	</style>
</head>
<body>
	<div class="about">cyclemap - <a class="about-link" href="about.html">about</a></div>
	<div id="map" class="map">
	</div>
	<div class="legend">
		<div class="pathLegend">
			<div class="legendItem"><div style="color: hsl(120, 60%, 30%);" class="pathLegendColor">█</div> paved</div>
			<div class="legendItem"><div style="color: hsl(25, 60%, 45%);" class="pathLegendColor">█</div> not paved?</div>
			<div class="legendItem" id="footLegend"><div style="color: hsl(0, 0%, 94%);" class="pathLegendColor">█</div> foot</div>
		</div>
		<div class="iconLegend">
			<div class="legendItem"><div class="icon" style="background-position: 0 -112px;"></div> shop</div>
			<div class="legendItem"><div class="icon" style="background-position: 0 -248px;"></div> station</div>
			<div class="legendItem"><div class="icon" style="background-position: -34px -248px;"></div> parking</div>
			<div class="legendItem"><div class="icon" style="background-position: -68px -248px;"></div> rental</div>
			<div class="legendItem"><div class="icon" style="background-position: -204px -112px;"></div> water</div>
		</div>
	</div>
	<script>

var highZoom = 12;

var query = new URLSearchParams(window.location.search);
var cookieOptions = { expires: 365 };

var map = setupMap();
addMoveListener();
checkAddGeoJsonLayer();

function setupMap() {
	//mapboxgl.setRTLTextPlugin('mapbox-gl-rtl-text.js');
	var defaultLatitude = 40;
	var defaultLongitude = -96;
	var defaultZoom = 5;
	var styleRoot = '';

	var latitude = Cookies.get('latitude') || defaultLatitude;
	var longitude = Cookies.get('longitude') || defaultLongitude;
	var zoom = Cookies.get('zoom') || defaultZoom;
	
	var defaultStyle = Cookies.get('style') != null ? Cookies.get('style') : 'style.json';
	var style = query.has('style') ? 'style-' + query.get('style') + '.json' : defaultStyle;

	Cookies.set('style', style, cookieOptions);

	var map = new mapboxgl.Map({
		container: 'map',
		style: styleRoot + style,
		center: new mapboxgl.LngLat(longitude, latitude),
		zoom: zoom,
		hash: true,
		dragRotate: false
	});
	map.addControl(new mapboxgl.NavigationControl());
	map.addControl(new mapboxgl.ScaleControl());
	map.addControl(new mapboxgl.GeolocateControl({
		positionOptions: {enableHighAccuracy: true},
		trackUserLocation: true
	}));
	map.on("contextmenu", e => {});
	return map;
}

function addMoveListener() {
	map.on('moveend', checkMove);
	checkMove();
	function checkMove() {
		var latitude = map.getCenter().lat, longitude = map.getCenter().lng, zoom = map.getZoom();

		Cookies.set('latitude', latitude, cookieOptions);
		Cookies.set('longitude', longitude, cookieOptions);
		Cookies.set('zoom', zoom, cookieOptions);

		//pass any location information to about
		var aboutUrl = `about.html#map=${(zoom+1).toFixed(0)}/${latitude.toFixed(5)}/${longitude.toFixed(5)}`;
		document.querySelectorAll('.about-link').forEach((element) => element.href = aboutUrl);
	}
	
	map.on('zoom', checkZoom);
	checkZoom();
	function checkZoom() {
		var highZoomEnabled = map.getZoom() >= highZoom;
		document.getElementById('footLegend').style.opacity = highZoomEnabled ? 1 : 0;
	}
}

function addGeoJsonLayer(id, type, data) {
	if(map.getSource(id) != null) {
		map.getSource(id).setData(data);
		return;
	}
	
	map.addSource(id, {
		type: 'geojson',
		data: data,
		attribution: 'external resource loaded'
	});
	map.addLayer({
		'id': id,
		'type': type,
		'source': id,
		...getOptions(type),
	});

	/*
	geojson.features.forEach(function (marker) {
		new mapboxgl.Marker()
			.setLngLat(marker.geometry.coordinates)
			.setPopup(new mapboxgl.Popup({ offset: 25 })
			.setHTML('<h3>' + marker.properties.title + '</h3><p>' + marker.properties.description + '</p>'))
			.addTo(map);
	});
	*/
}

function checkAddGeoJsonLayer() {
	var geoJsonData = query.get('geo'), type = query.get('type') != null ? query.get('type') : 'symbol';
	if(geoJsonData !== null) {
		map.on('load', function() {addGeoJsonLayer('geoJsonData', type, geoJsonData);});
	}
	map.on("mouseup", e => {
		var event = e.originalEvent;
		
		if(event.button === 2) {
			//right click
			alert(e.lngLat.lat.toFixed(4) + "," + e.lngLat.lng.toFixed(4));
		}
	});
}

function ajaxGet(url, callback) {
	var xhttp = new XMLHttpRequest();
	xhttp.addEventListener("load", function() {callback(JSON.parse(this.responseText));});
	xhttp.addEventListener("error", function() {console.error('trouble making request.  response:  ', this.statusText);});
	xhttp.open("GET", url, true);
	xhttp.send();
}


function getOptions(type) {
	if(type == 'symbol') {
		return {'layout': {
			'icon-image': '{marker-symbol}_11',
			'icon-size': 1.5,
			'text-field': '{title}',
			'icon-allow-overlap': true,
			'text-allow-overlap': true,
			'text-anchor': 'top',
			'text-font': ['Noto Sans Italic'],
			'text-max-width': 9,
			'icon-offset': [0, -3],
			'text-offset': [0, .2],
			'text-padding': 2,
			'text-size': 12,
		},
		'paint': {
			'text-color': '#666',
			'text-halo-blur': 0.5,
			'text-halo-color': 'white',
			'text-halo-width': 2,
		}};
	}
	else if(type == 'line') {
		return {'layout': {
			'line-join': 'round',
		},
		'paint': {
			'line-color': '#00d',
			'line-width': {
				'stops': [[15, 8], [20, 16]],
			},
			'line-opacity': .5,
		}};
	}
	console.error('unknown type: ', type);
}

	</script>
</body>
</html>
